<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" type="image/avif" href="../assets/img/FavIcon.avif">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/FavIcon.avif">
  <title>Blocklist Management - Uqudo Admin Portal</title>

  <!-- Authentication & URL Protection -->
  <script>
    // Block direct .html access - redirect to clean URLs
    if (window.location.pathname.endsWith('.html')) {
      const cleanPath = window.location.pathname.replace('.html', '');
      window.location.replace(cleanPath + window.location.search + window.location.hash);
    }

    // Check authentication before page loads
    (function() {
      const authToken = localStorage.getItem('uqudo_token') || localStorage.getItem('auth_token');
      if (!authToken) {
        window.location.replace('/pages/uqudo-sign-in');
      }
    })();
  </script>

  <!-- Fonts and icons -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">

  <!-- Material Dashboard CSS -->
  <link id="pagestyle" href="../assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />
  <link href="../assets/css/uqudo-blue-theme.css" rel="stylesheet" />

  <style>
    .filter-section {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
    }
    .blocklist-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
    }
    .entry-type-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>

<body class="g-sidenav-show bg-gray-200">

  <!-- Sidebar -->
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-radius-lg fixed-start ms-2 bg-white my-2" id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-dark opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0 p-0 d-block w-100" href="uqudo-dashboard">
        <img src="../assets/img/uqudo-logo.png" alt="Uqudo Logo" style="width: 100%; height: auto; display: block;">
      </a>
    </div>
    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-dark" href="uqudo-dashboard">
            <i class="material-symbols-rounded opacity-5">dashboard</i>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="accounts">
            <i class="material-symbols-rounded opacity-5">group</i>
            <span class="nav-link-text ms-1">Accounts</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="alerts">
            <i class="material-symbols-rounded opacity-5">notifications_active</i>
            <span class="nav-link-text ms-1">KYC Alerts</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="cases">
            <i class="material-symbols-rounded opacity-5">gavel</i>
            <span class="nav-link-text ms-1">AML Cases</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder opacity-5">Configuration</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="kyc-setup">
            <i class="material-symbols-rounded opacity-5">settings</i>
            <span class="nav-link-text ms-1">KYC Setup</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active bg-gradient-info text-white" href="blocklist">
            <i class="material-symbols-rounded opacity-5">block</i>
            <span class="nav-link-text ms-1">Blocklist</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">

    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Configuration</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Blocklist</li>
          </ol>
          <h6 class="font-weight-bold mb-0">Blocklist Management</h6>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
          </div>
          <ul class="navbar-nav justify-content-end">
            <li class="nav-item d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white bg-gradient-info font-weight-bold px-3 border-radius-md" onclick="logout()">
                <i class="material-symbols-rounded me-sm-1">logout</i>
                <span class="d-sm-inline d-none">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
    <div class="container-fluid py-2">

      <!-- Blocklist Statistics -->
      <div class="row mb-4">
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-header p-2 ps-3">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-sm mb-0 editable-label"
                     data-key="blocklist_total_label"
                     data-default="Total Entries"
                     style="cursor: pointer;">Total Entries</p>
                  <h4 class="mb-0" id="total-entries">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h4>
                </div>
                <div class="icon icon-md icon-shape bg-gradient-info shadow-info text-center border-radius-lg">
                  <i class="material-symbols-rounded opacity-10 text-white">block</i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-header p-2 ps-3">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-sm mb-0 editable-label"
                     data-key="blocklist_active_label"
                     data-default="Active Blocks"
                     style="cursor: pointer;">Active Blocks</p>
                  <h4 class="mb-0 text-danger" id="active-entries">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h4>
                </div>
                <div class="icon icon-md icon-shape bg-gradient-info shadow-info text-center border-radius-lg">
                  <i class="material-symbols-rounded opacity-10 text-white">do_not_disturb</i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-header p-2 ps-3">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-sm mb-0 editable-label"
                     data-key="blocklist_email_label"
                     data-default="Email Blocks"
                     style="cursor: pointer;">Email Blocks</p>
                  <h4 class="mb-0" id="email-entries">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h4>
                </div>
                <div class="icon icon-md icon-shape bg-gradient-info shadow-info text-center border-radius-lg">
                  <i class="material-symbols-rounded opacity-10 text-white">mail</i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6">
          <div class="card">
            <div class="card-header p-2 ps-3">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-sm mb-0 editable-label"
                     data-key="blocklist_document_label"
                     data-default="Document Blocks"
                     style="cursor: pointer;">Document Blocks</p>
                  <h4 class="mb-0" id="document-entries">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h4>
                </div>
                <div class="icon icon-md icon-shape bg-gradient-info shadow-info text-center border-radius-lg">
                  <i class="material-symbols-rounded opacity-10 text-white">badge</i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="filter-section">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label text-xs mb-1">Search</label>
                    <input type="text" class="form-control form-control-sm" id="search-input" placeholder="Name, email, or document number">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label text-xs mb-1">Type</label>
                    <select class="form-select form-select-sm" id="filter-type">
                      <option value="">All Types</option>
                      <option value="email">Email</option>
                      <option value="phone">Phone</option>
                      <option value="document">Document</option>
                      <option value="name">Name</option>
                      <option value="ip_address">IP Address</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label text-xs mb-1">Status</label>
                    <select class="form-select form-select-sm" id="filter-status">
                      <option value="">All Statuses</option>
                      <option value="active">Active</option>
                      <option value="inactive">Inactive</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label text-xs mb-1">&nbsp;</label>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm bg-gradient-info text-white flex-grow-1" onclick="applyFilters()">
                        <i class="material-symbols-rounded text-sm">filter_alt</i> Apply Filters
                      </button>
                      <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">
                        <i class="material-symbols-rounded text-sm">clear</i>
                      </button>
                      <button class="btn btn-sm bg-gradient-success text-white" onclick="openAddEntryModal()">
                        <i class="material-symbols-rounded text-sm">add</i> Add Entry
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Blocklist Table -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Blocklist Entries</h6>
                <div>
                  <button class="btn btn-info btn-sm mb-0 me-2" data-bs-toggle="modal" data-bs-target="#addEntryModal">
                    <i class="material-symbols-rounded me-1">add</i> Add Entry
                  </button>
                  <button class="btn btn-outline-info btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#uploadCsvModal">
                    <i class="material-symbols-rounded me-1">upload</i> Upload CSV
                  </button>
                  <span class="text-sm text-secondary ms-3" id="entries-count">Loading...</span>
                </div>
              </div>
            </div>
            <div class="card-body px-0 pb-2">
              <div class="table-responsive p-0">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Entry</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Type</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Value</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Reason</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Added</th>
                      <th class="text-secondary opacity-7"></th>
                    </tr>
                  </thead>
                  <tbody id="blocklist-table-body">
                    <tr>
                      <td colspan="7" class="text-center py-4">
                        <div class="spinner-border text-info" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="px-3 py-3" id="pagination-container"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Add Entry Modal -->
  <div class="modal fade" id="addEntryModal" tabindex="-1" aria-labelledby="addEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addEntryModalLabel">Add Blocklist Entry</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Entry Type</label>
            <select class="form-select" id="entry-type" required onchange="updateValuePlaceholder()">
              <option value="">Select type...</option>
              <option value="email">Email Address</option>
              <option value="phone">Phone Number</option>
              <option value="document">Document Number</option>
              <option value="name">Full Name</option>
              <option value="ip_address">IP Address</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Value</label>
            <input type="text" class="form-control" id="entry-value" placeholder="Enter value to block" required>
            <small class="form-text text-muted" id="value-hint"></small>
          </div>

          <div class="mb-3">
            <label class="form-label">Reason for Blocking</label>
            <select class="form-select" id="entry-reason" required>
              <option value="">Select reason...</option>
              <option value="fraud">Fraud / Suspicious Activity</option>
              <option value="sanctions">Sanctions List Match</option>
              <option value="pep">PEP / High Risk Individual</option>
              <option value="duplicate">Duplicate Account</option>
              <option value="policy_violation">Policy Violation</option>
              <option value="legal_request">Legal / Regulatory Request</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Additional Notes</label>
            <textarea class="form-control" id="entry-notes" rows="3" placeholder="Provide additional context..."></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Expires On (Optional)</label>
            <input type="date" class="form-control" id="entry-expires-at">
            <small class="form-text text-muted">Leave blank for permanent block</small>
          </div>

          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="entry-is-active" checked>
            <label class="form-check-label" for="entry-is-active">Active (Block immediately)</label>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="create-alert-checkbox">
            <label class="form-check-label" for="create-alert-checkbox">
              Create alert if matching account exists
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn bg-gradient-info" onclick="saveEntry()">Add to Blocklist</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Entry Modal -->
  <div class="modal fade" id="editEntryModal" tabindex="-1" aria-labelledby="editEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editEntryModalLabel">Edit Blocklist Entry</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-entry-id">

          <div class="mb-3">
            <label class="form-label">Entry Type</label>
            <input type="text" class="form-control" id="edit-entry-type" disabled>
          </div>

          <div class="mb-3">
            <label class="form-label">Value</label>
            <input type="text" class="form-control" id="edit-entry-value" disabled>
          </div>

          <div class="mb-3">
            <label class="form-label">Reason for Blocking</label>
            <select class="form-select" id="edit-entry-reason" required>
              <option value="fraud">Fraud / Suspicious Activity</option>
              <option value="sanctions">Sanctions List Match</option>
              <option value="pep">PEP / High Risk Individual</option>
              <option value="duplicate">Duplicate Account</option>
              <option value="policy_violation">Policy Violation</option>
              <option value="legal_request">Legal / Regulatory Request</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Additional Notes</label>
            <textarea class="form-control" id="edit-entry-notes" rows="3"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Expires On (Optional)</label>
            <input type="date" class="form-control" id="edit-entry-expires-at">
          </div>

          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="edit-entry-is-active">
            <label class="form-check-label" for="edit-entry-is-active">Active</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn bg-gradient-info" onclick="updateEntry()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload CSV Modal -->
  <div class="modal fade" id="uploadCsvModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upload Blocklist CSV</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <strong>CSV Format:</strong> full_name,id_type,id_number,nationality,source<br>
            <strong>Example:</strong> John Doe,passport,PASS123,US,OFAC_List
          </div>
          <div class="mb-3">
            <label class="form-label">Select CSV File</label>
            <input type="file" class="form-control" id="csv-file-input" accept=".csv" onchange="previewCsv()">
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="csv-create-alerts">
            <label class="form-check-label" for="csv-create-alerts">
              Create alerts for matching accounts
            </label>
          </div>
          <div id="csv-preview" class="border rounded p-3 d-none" style="max-height: 400px; overflow: auto;">
            <h6>Preview:</h6>
            <table class="table table-sm">
              <thead><tr><th>Full Name</th><th>ID Type</th><th>ID Number</th><th>Nationality</th><th>Source</th></tr></thead>
              <tbody id="csv-preview-body"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-info" onclick="submitCsvUpload()" id="csv-upload-btn" disabled>Upload</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/api-client.js"></script>
  <script src="../assets/js/utils.js"></script>

  <script>
    // api is already defined globally in api-client.js
    let entries = [];
    let currentPage = 1;
    let totalPages = 1;
    let currentFilters = {};

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadBlocklistStats();
      loadBlocklist();

      // Search on Enter
      document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') applyFilters();
      });
    });

    // Load blocklist statistics
    async function loadBlocklistStats() {
      try {
        // Fetch all blocklist entries to calculate stats
        const response = await api.getBlocklist({ limit: 1000 });
        if (response.success) {
          const allEntries = response.data || [];
          const total = response.pagination?.total || allEntries.length;

          // Calculate type counts
          const active = allEntries.filter(e => e.is_active).length;
          const email = allEntries.filter(e => e.entry_type === 'email').length;
          const document = allEntries.filter(e => e.entry_type === 'document').length;

          document.getElementById('total-entries').textContent = formatNumber(total);
          document.getElementById('active-entries').textContent = formatNumber(active);
          document.getElementById('email-entries').textContent = formatNumber(email);
          document.getElementById('document-entries').textContent = formatNumber(document);
        }
      } catch (error) {
        console.error('Failed to load blocklist stats:', error);
        // Set to 0 on error
        document.getElementById('total-entries').textContent = '0';
        document.getElementById('active-entries').textContent = '0';
        document.getElementById('email-entries').textContent = '0';
        document.getElementById('document-entries').textContent = '0';
      }
    }

    // Load blocklist entries
    async function loadBlocklist(page = 1) {
      currentPage = page;
      const tableBody = document.getElementById('blocklist-table-body');
      tableBody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center py-4">
            <div class="spinner-border text-info" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </td>
        </tr>
      `;

      try {
        const params = {
          page: page,
          limit: 20,
          ...currentFilters
        };

        const response = await api.getBlocklist(params);

        if (response.success) {
          entries = response.data.entries || response.data;
          totalPages = response.data.totalPages || 1;
          const total = response.data.total || entries.length;

          document.getElementById('entries-count').textContent =
            `Showing ${entries.length} of ${formatNumber(total)} entries`;

          if (entries.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" class="text-center py-4">
                  <i class="material-symbols-rounded text-secondary" style="font-size: 48px;">inbox</i>
                  <p class="text-secondary mb-0">No blocklist entries found</p>
                </td>
              </tr>
            `;
            return;
          }

          tableBody.innerHTML = entries.map(entry => {
            const typeIcon = getEntryTypeIcon(entry.entry_type);

            return `
              <tr>
                <td>
                  <div class="d-flex px-2 py-1">
                    <div class="entry-type-icon ${typeIcon.bgClass}">
                      <i class="material-symbols-rounded text-sm text-white">${typeIcon.icon}</i>
                    </div>
                    <div class="d-flex flex-column justify-content-center ms-2">
                      <h6 class="mb-0 text-sm">${snakeToTitle(entry.entry_type)}</h6>
                      <p class="text-xs text-secondary mb-0">ID: ${entry.id.substring(0, 8)}...</p>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="badge badge-sm blocklist-badge ${getEntryTypeBadge(entry.entry_type)}">
                    ${snakeToTitle(entry.entry_type)}
                  </span>
                </td>
                <td>
                  <p class="text-xs font-weight-bold mb-0">${entry.value}</p>
                </td>
                <td>
                  <p class="text-xs mb-0">${snakeToTitle(entry.reason)}</p>
                </td>
                <td class="align-middle text-center">
                  <span class="badge badge-sm ${entry.is_active ? 'badge-danger' : 'badge-secondary'}">
                    ${entry.is_active ? 'Active' : 'Inactive'}
                  </span>
                </td>
                <td class="align-middle text-center">
                  <span class="text-secondary text-xs">${formatDate(entry.created_at, { dateStyle: 'short' })}</span>
                  ${entry.expires_at ? `<br><small class="text-xs text-warning">Expires: ${formatDate(entry.expires_at, { dateStyle: 'short' })}</small>` : ''}
                </td>
                <td class="align-middle">
                  <button class="btn btn-link text-secondary mb-0 p-0" onclick="editEntry('${entry.id}')">
                    <i class="material-symbols-rounded text-sm">edit</i>
                  </button>
                  <button class="btn btn-link text-danger mb-0 p-0" onclick="deleteEntry('${entry.id}')">
                    <i class="material-symbols-rounded text-sm">delete</i>
                  </button>
                </td>
              </tr>
            `;
          }).join('');

          // Build pagination
          buildPagination('pagination-container', currentPage, totalPages, loadBlocklist);
        }
      } catch (error) {
        console.error('Failed to load blocklist:', error);
        showError('Failed to load blocklist');
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-4 text-danger">
              <i class="material-symbols-rounded">error</i>
              <p>Failed to load blocklist</p>
            </td>
          </tr>
        `;
      }
    }

    // Apply filters
    function applyFilters() {
      currentFilters = {};

      const search = document.getElementById('search-input').value.trim();
      const type = document.getElementById('filter-type').value;
      const status = document.getElementById('filter-status').value;

      if (search) currentFilters.search = search;
      if (type) currentFilters.entry_type = type;
      if (status) currentFilters.is_active = status === 'active';

      loadBlocklist(1);
    }

    // Clear filters
    function clearFilters() {
      document.getElementById('search-input').value = '';
      document.getElementById('filter-type').value = '';
      document.getElementById('filter-status').value = '';
      currentFilters = {};
      loadBlocklist(1);
    }

    // Open add entry modal
    function openAddEntryModal() {
      const modal = new bootstrap.Modal(document.getElementById('addEntryModal'));
      document.getElementById('entry-type').value = '';
      document.getElementById('entry-value').value = '';
      document.getElementById('entry-reason').value = '';
      document.getElementById('entry-notes').value = '';
      document.getElementById('entry-expires-at').value = '';
      document.getElementById('entry-is-active').checked = true;
      document.getElementById('value-hint').textContent = '';
      modal.show();
    }

    // Update value placeholder based on type
    function updateValuePlaceholder() {
      const type = document.getElementById('entry-type').value;
      const valueInput = document.getElementById('entry-value');
      const hint = document.getElementById('value-hint');

      const placeholders = {
        email: { placeholder: 'user@example.com', hint: 'Enter full email address' },
        phone: { placeholder: '+1234567890', hint: 'Enter phone with country code' },
        document: { placeholder: 'ABC123456', hint: 'Enter document/ID number' },
        name: { placeholder: 'John Doe', hint: 'Enter full name' },
        ip_address: { placeholder: '192.168.1.1', hint: 'Enter IP address' }
      };

      if (placeholders[type]) {
        valueInput.placeholder = placeholders[type].placeholder;
        hint.textContent = placeholders[type].hint;
      } else {
        valueInput.placeholder = 'Enter value to block';
        hint.textContent = '';
      }
    }

    // Save entry
    async function saveEntry() {
      const entryType = document.getElementById('entry-type').value;
      const value = document.getElementById('entry-value').value.trim();
      const reason = document.getElementById('entry-reason').value;
      const notes = document.getElementById('entry-notes').value.trim();
      const expiresAt = document.getElementById('entry-expires-at').value;
      const isActive = document.getElementById('entry-is-active').checked;
      const createAlert = document.getElementById('create-alert-checkbox').checked;

      if (!entryType || !value || !reason) {
        showError('Please fill in all required fields');
        return;
      }

      // Map frontend fields to backend schema
      let fullName = '';
      let identifier = '';

      // Set full_name and identifier based on entry type
      if (entryType === 'name') {
        fullName = value;
      } else if (entryType === 'email') {
        fullName = 'Email: ' + value;
        identifier = value;
      } else if (entryType === 'phone') {
        fullName = 'Phone: ' + value;
        identifier = value;
      } else if (entryType === 'ip_address') {
        fullName = 'IP Address: ' + value;
        identifier = value;
      } else if (entryType === 'document') {
        fullName = 'Document: ' + value;
        identifier = value;
      } else {
        fullName = value; // Fallback
      }

      const entryData = {
        type: 'custom', // Default type for manual entries
        full_name: fullName,
        identifier: identifier,
        source: reason, // Use reason as source
        notes: notes,
        create_alert: createAlert
      };

      if (expiresAt) {
        entryData.expires_at = expiresAt;
      }

      // Debug log
      console.log('Sending blocklist entry:', entryData);

      try {
        const response = await api.addBlocklistEntry(entryData);

        if (response.success) {
          showSuccess('Entry added to blocklist successfully');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addEntryModal'));
          modal.hide();
          loadBlocklist(currentPage);
          loadBlocklistStats();
        } else {
          showError(response.error || 'Failed to add entry');
        }
      } catch (error) {
        console.error('Failed to add entry:', error);
        showError('Failed to add entry');
      }
    }

    // Edit entry
    async function editEntry(entryId) {
      const entry = entries.find(e => e.id === entryId);
      if (!entry) return;

      const modal = new bootstrap.Modal(document.getElementById('editEntryModal'));

      document.getElementById('edit-entry-id').value = entry.id;
      document.getElementById('edit-entry-type').value = snakeToTitle(entry.entry_type);
      document.getElementById('edit-entry-value').value = entry.value;
      document.getElementById('edit-entry-reason').value = entry.reason;
      document.getElementById('edit-entry-notes').value = entry.notes || '';
      document.getElementById('edit-entry-expires-at').value = entry.expires_at ? entry.expires_at.split('T')[0] : '';
      document.getElementById('edit-entry-is-active').checked = entry.is_active;

      modal.show();
    }

    // Update entry
    async function updateEntry() {
      const entryId = document.getElementById('edit-entry-id').value;
      const reason = document.getElementById('edit-entry-reason').value;
      const notes = document.getElementById('edit-entry-notes').value.trim();
      const expiresAt = document.getElementById('edit-entry-expires-at').value;
      const isActive = document.getElementById('edit-entry-is-active').checked;

      const updateData = {
        reason: reason,
        notes: notes,
        is_active: isActive
      };

      if (expiresAt) {
        updateData.expires_at = expiresAt;
      }

      try {
        const response = await api.updateBlocklistEntry(entryId, updateData);

        if (response.success) {
          showSuccess('Entry updated successfully');
          const modal = bootstrap.Modal.getInstance(document.getElementById('editEntryModal'));
          modal.hide();
          loadBlocklist(currentPage);
          loadBlocklistStats();
        } else {
          showError(response.error || 'Failed to update entry');
        }
      } catch (error) {
        console.error('Failed to update entry:', error);
        showError('Failed to update entry');
      }
    }

    // Delete entry
    async function deleteEntry(entryId) {
      const confirmed = await confirmAction('Are you sure you want to remove this entry from the blocklist?', 'Delete Entry');

      if (confirmed) {
        try {
          const response = await api.deleteBlocklistEntry(entryId);

          if (response.success) {
            showSuccess('Entry removed from blocklist');
            loadBlocklist(currentPage);
            loadBlocklistStats();
          } else {
            showError(response.error || 'Failed to delete entry');
          }
        } catch (error) {
          console.error('Failed to delete entry:', error);
          showError('Failed to delete entry');
        }
      }
    }

    // Helper functions
    function getEntryTypeIcon(type) {
      const icons = {
        email: { icon: 'mail', bgClass: 'bg-gradient-warning' },
        phone: { icon: 'phone', bgClass: 'bg-gradient-info' },
        document: { icon: 'badge', bgClass: 'bg-gradient-success' },
        name: { icon: 'person', bgClass: 'bg-gradient-primary' },
        ip_address: { icon: 'router', bgClass: 'bg-gradient-danger' }
      };
      return icons[type] || { icon: 'block', bgClass: 'bg-gradient-secondary' };
    }

    function getEntryTypeBadge(type) {
      const badges = {
        email: 'badge-warning',
        phone: 'badge-info',
        document: 'badge-success',
        name: 'badge-primary',
        ip_address: 'badge-danger'
      };
      return badges[type] || 'badge-secondary';
    }

    // CSV Upload Functions
    let csvData = [];

    function previewCsv() {
      const fileInput = document.getElementById('csv-file-input');
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim());

        // Skip header row if it exists
        const startIndex = lines[0].toLowerCase().includes('full_name') ? 1 : 0;

        csvData = lines.slice(startIndex).map(line => {
          const [full_name, id_type, id_number, nationality, source] = line.split(',').map(s => s.trim());
          return { full_name, id_type, id_number, nationality, source, type: 'custom' };
        }).filter(entry => entry.full_name); // Filter out empty rows

        // Show preview
        const tbody = document.getElementById('csv-preview-body');
        tbody.innerHTML = csvData.slice(0, 10).map(entry => `
          <tr>
            <td>${entry.full_name}</td>
            <td>${entry.id_type || '-'}</td>
            <td>${entry.id_number || '-'}</td>
            <td>${entry.nationality || '-'}</td>
            <td>${entry.source || '-'}</td>
          </tr>
        `).join('');

        if (csvData.length > 10) {
          tbody.innerHTML += `
            <tr>
              <td colspan="5" class="text-center text-muted">
                ... and ${csvData.length - 10} more rows
              </td>
            </tr>
          `;
        }

        document.getElementById('csv-preview').classList.remove('d-none');
        document.getElementById('csv-upload-btn').disabled = csvData.length === 0;
      };
      reader.readAsText(file);
    }

    async function submitCsvUpload() {
      const createAlerts = document.getElementById('csv-create-alerts').checked;

      try {
        const response = await api.importBlocklist({
          entries: csvData,
          create_alert: createAlerts
        });

        if (response.success) {
          showSuccess(`Successfully imported ${response.data.imported} entries`);
          bootstrap.Modal.getInstance(document.getElementById('uploadCsvModal')).hide();
          document.getElementById('csv-file-input').value = '';
          document.getElementById('csv-preview').classList.add('d-none');
          csvData = [];
          loadBlocklist(1);
          loadBlocklistStats();
        }
      } catch (error) {
        showError(error.message || 'Failed to upload CSV');
      }
    }

    function logout() {
      localStorage.removeItem('uqudo_token');
      localStorage.removeItem('uqudo_user');
      window.location.href = 'uqudo-sign-in.html';
    }
  </script>

  <!-- Editable Labels Script -->
  <script src="../assets/js/editable-labels.js"></script>

  <!-- Vercel Analytics -->
  <script type="module">
    import { inject } from 'https://cdn.jsdelivr.net/npm/@vercel/analytics@1.6.1/+esm';
    inject();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" type="image/avif" href="../assets/img/FavIcon.avif">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/FavIcon.avif">
  <title>Uqudo - Start Verification</title>

  <!-- Fonts and icons -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

  <!-- CSS Files -->
  <link id="pagestyle" href="../assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />
  <link href="../assets/css/uqudo-blue-theme.css" rel="stylesheet" />
  <link href="../assets/css/dark-mode.css" rel="stylesheet" />

  <style>
    .verify-container {
      max-width: 500px;
      margin: 0 auto;
    }

    .app-icon {
      width: 80px;
      height: 80px;
      border-radius: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .app-icon i {
      font-size: 2.5rem;
      color: white;
    }

    .btn-open-app {
      padding: 1rem 2rem;
      font-size: 1.1rem;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .btn-open-app:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .store-badge {
      height: 50px;
      transition: transform 0.2s ease;
    }

    .store-badge:hover {
      transform: scale(1.05);
    }

    .step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .step-item {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid #f0f2f5;
    }

    .step-item:last-child {
      border-bottom: none;
    }

    .session-info {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-family: monospace;
      font-size: 0.85rem;
    }

    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }

    .expired-icon {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #fff3e0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
    }

    .expired-icon i {
      font-size: 3rem;
      color: #f57c00;
    }
  </style>
</head>

<body class="bg-gray-200">
  <div class="container position-sticky z-index-sticky top-0">
    <div class="row">
      <div class="col-12">
        <nav class="navbar navbar-expand-lg blur border-radius-xl top-0 z-index-3 shadow position-absolute my-3 py-2 start-0 end-0 mx-4">
          <div class="container-fluid ps-2 pe-0">
            <a class="navbar-brand font-weight-bolder ms-lg-0 ms-3" href="#">
              <img src="../assets/img/uqudo-logo.svg" alt="Uqudo Logo" style="height: 32px;">
            </a>
          </div>
        </nav>
      </div>
    </div>
  </div>

  <main class="main-content mt-0">
    <div class="page-header align-items-start min-vh-100" style="background-image: url('https://images.unsplash.com/photo-1557683316-973673baf926?ixlib=rb-4.0.3&auto=format&fit=crop&w=2029&q=80');">
      <span class="mask bg-gradient-info opacity-6"></span>
      <div class="container my-auto pt-6">
        <div class="row justify-content-center">
          <div class="col-lg-5 col-md-8 col-12">
            <div class="card z-index-0 fadeIn3 fadeInBottom">
              <div class="card-body text-center py-5 verify-container">

                <!-- Loading State -->
                <div id="loading-state" class="loading-state">
                  <div class="spinner-border text-info mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="text-muted">Preparing verification...</p>
                </div>

                <!-- Expired State -->
                <div id="expired-state" class="d-none">
                  <div class="expired-icon">
                    <i class="fas fa-clock"></i>
                  </div>
                  <h4 class="text-dark mb-3">Link Expired</h4>
                  <p class="text-muted mb-4">This verification link has expired. Please request a new verification link from your service provider.</p>
                  <div class="session-info text-muted mb-4">
                    Session: <span id="expired-session-id">-</span>
                  </div>
                </div>

                <!-- Error State -->
                <div id="error-state" class="d-none">
                  <div class="expired-icon" style="background: #ffebee;">
                    <i class="fas fa-exclamation-triangle" style="color: #f44336;"></i>
                  </div>
                  <h4 class="text-dark mb-3">Invalid Link</h4>
                  <p class="text-muted mb-4" id="error-message">This verification link is invalid or has already been used.</p>
                </div>

                <!-- Main Verify State -->
                <div id="verify-state" class="d-none">
                  <div class="app-icon">
                    <i class="fas fa-id-card"></i>
                  </div>

                  <h4 class="text-dark mb-2">Identity Verification</h4>
                  <p class="text-muted mb-4">Complete your KYC verification using the Uqudo app</p>

                  <!-- Open App Button -->
                  <button id="open-app-btn" class="btn btn-open-app bg-gradient-info text-white w-100 mb-4" onclick="openApp()">
                    <i class="fas fa-mobile-alt me-2"></i>Open in Uqudo App
                  </button>

                  <!-- Instructions -->
                  <div class="text-start mb-4">
                    <h6 class="text-dark mb-3">
                      <i class="fas fa-list-ol text-info me-2"></i>How it works
                    </h6>

                    <div class="step-item">
                      <span class="step-number">1</span>
                      <div>
                        <strong class="text-dark">Open the app</strong>
                        <p class="text-muted text-sm mb-0">Tap the button above to launch the Uqudo app</p>
                      </div>
                    </div>

                    <div class="step-item">
                      <span class="step-number">2</span>
                      <div>
                        <strong class="text-dark">Scan your document</strong>
                        <p class="text-muted text-sm mb-0">Take a photo of your ID document</p>
                      </div>
                    </div>

                    <div class="step-item">
                      <span class="step-number">3</span>
                      <div>
                        <strong class="text-dark">Take a selfie</strong>
                        <p class="text-muted text-sm mb-0">Verify your identity with a quick selfie</p>
                      </div>
                    </div>
                  </div>

                  <!-- Download App Section -->
                  <div class="border-top pt-4">
                    <p class="text-muted text-sm mb-3">Don't have the app? Download it:</p>
                    <div class="d-flex justify-content-center gap-3">
                      <a href="https://apps.apple.com/app/uqudo" target="_blank" rel="noopener">
                        <img src="https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg" alt="Download on App Store" class="store-badge">
                      </a>
                      <a href="https://play.google.com/store/apps/details?id=com.uqudo.app" target="_blank" rel="noopener">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" alt="Get it on Google Play" class="store-badge">
                      </a>
                    </div>
                  </div>

                  <!-- Session Info -->
                  <div class="mt-4 pt-3 border-top">
                    <small class="text-muted">Session ID</small>
                    <div class="session-info" id="session-id">-</div>
                  </div>
                </div>

              </div>
            </div>

            <div class="text-center mt-4">
              <p class="text-white text-sm opacity-8">
                <i class="fas fa-shield-alt me-1"></i>
                Secure identity verification powered by Uqudo
              </p>
            </div>
          </div>
        </div>
      </div>

      <footer class="footer position-absolute bottom-2 py-2 w-100">
        <div class="container">
          <div class="row align-items-center justify-content-center">
            <div class="col-12 col-md-6 my-auto">
              <div class="copyright text-center text-sm text-white">
                Â© <script>document.write(new Date().getFullYear())</script> Uqudo - Secure Identity Verification
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </main>

  <!-- Core JS Files -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../assets/js/material-dashboard.min.js?v=3.2.0"></script>

  <script>
    // Configuration
    const API_BASE_URL = window.location.origin + '/api';
    const DEEP_LINK_SCHEME = 'uqudo://verify';

    // State
    let sessionData = null;

    // Get URL parameters
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        token: params.get('token'),
        session: params.get('session')
      };
    }

    // Initialize page
    async function init() {
      const params = getUrlParams();

      if (!params.token) {
        showError('Missing verification token');
        return;
      }

      try {
        // Check session status
        const response = await fetch(`${API_BASE_URL}/qr-verification/status/${params.session}`);
        const data = await response.json();

        if (!data.success) {
          // Session not found - might still be valid if in memory only
          // Show the verify state anyway
          sessionData = {
            token: params.token,
            session_id: params.session
          };
          showVerifyState();
          return;
        }

        // Check if expired
        if (data.data.status === 'expired' || new Date(data.data.expires_at) < new Date()) {
          showExpired(params.session);
          return;
        }

        // Check if already completed
        if (data.data.status === 'completed') {
          showError('This verification has already been completed');
          return;
        }

        // Store session data
        sessionData = {
          ...data.data,
          token: params.token
        };

        // Show verify state
        showVerifyState();

        // Auto-attempt to open app on mobile
        if (isMobile()) {
          setTimeout(() => {
            openApp();
          }, 500);
        }

      } catch (error) {
        console.error('Init error:', error);
        // Even on error, try to show verify state with available params
        sessionData = {
          token: params.token,
          session_id: params.session
        };
        showVerifyState();
      }
    }

    // Show verify state
    function showVerifyState() {
      document.getElementById('loading-state').classList.add('d-none');
      document.getElementById('expired-state').classList.add('d-none');
      document.getElementById('error-state').classList.add('d-none');
      document.getElementById('verify-state').classList.remove('d-none');

      document.getElementById('session-id').textContent = sessionData.session_id || '-';
    }

    // Show expired state
    function showExpired(sessionId) {
      document.getElementById('loading-state').classList.add('d-none');
      document.getElementById('verify-state').classList.add('d-none');
      document.getElementById('error-state').classList.add('d-none');
      document.getElementById('expired-state').classList.remove('d-none');

      document.getElementById('expired-session-id').textContent = sessionId || '-';
    }

    // Show error state
    function showError(message) {
      document.getElementById('loading-state').classList.add('d-none');
      document.getElementById('verify-state').classList.add('d-none');
      document.getElementById('expired-state').classList.add('d-none');
      document.getElementById('error-state').classList.remove('d-none');

      document.getElementById('error-message').textContent = message;
    }

    // Check if mobile device
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Open app with deep link
    function openApp() {
      if (!sessionData || !sessionData.token) {
        alert('Session data not available');
        return;
      }

      const params = new URLSearchParams({
        token: sessionData.token,
        session: sessionData.session_id
      });

      const deepLink = `${DEEP_LINK_SCHEME}?${params.toString()}`;

      // Try to open the app
      window.location.href = deepLink;

      // After a delay, if still on this page, the app didn't open
      // (user doesn't have app installed or deep link failed)
      setTimeout(() => {
        // Could show a prompt to download the app
        console.log('Deep link may have failed - app might not be installed');
      }, 2000);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', init);
  </script>

  <!-- Theme Manager -->
  <script src="../assets/js/theme-manager.js"></script>

  <!-- Vercel Analytics -->
  <script type="module">
    import { inject } from 'https://cdn.jsdelivr.net/npm/@vercel/analytics@1.6.1/+esm';
    inject();
  </script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" type="image/avif" href="../assets/img/FavIcon.avif">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/FavIcon.avif">
  <title>Uqudo - Identity Verification</title>

  <!-- Fonts and icons -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome from cdnjs (more reliable) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

  <!-- CSS Files -->
  <link id="pagestyle" href="../assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />
  <link href="../assets/css/uqudo-blue-theme.css" rel="stylesheet" />
  <link href="../assets/css/dark-mode.css" rel="stylesheet" />

  <!-- QR Code Library - hosted locally for reliability -->
  <script src="../assets/js/plugins/qrcode.min.js"></script>

  <style>
    .qr-container {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    .qr-code-wrapper {
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      display: inline-block;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    #qr-code canvas {
      display: block;
      margin: 0 auto;
    }

    .verification-info {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1.5rem;
    }

    .info-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #f0f2f5;
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      font-size: 1.2rem;
    }

    .info-icon.scan { background: #e3f2fd; color: #1976d2; }
    .info-icon.verify { background: #e8f5e9; color: #388e3c; }
    .info-icon.secure { background: #fff3e0; color: #f57c00; }

    .countdown-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .countdown-badge.expired {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4caf50;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
      100% { opacity: 1; transform: scale(1); }
    }

    .customer-badge {
      background: linear-gradient(135deg, #00c6fb 0%, #005bea 100%);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .loading-skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .btn-copy {
      transition: all 0.3s ease;
    }

    .btn-copy:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn-copy.copied {
      background: #4caf50 !important;
    }

    .deep-link-url {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      font-size: 0.85rem;
      word-break: break-all;
      color: #495057;
    }

    .app-store-badges img {
      height: 45px;
      transition: transform 0.2s ease;
    }

    .app-store-badges img:hover {
      transform: scale(1.05);
    }
  </style>
</head>

<body class="bg-gray-200">
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50" style="z-index: 9999;">
    <div class="d-flex justify-content-center align-items-center h-100">
      <div class="text-center text-white">
        <div class="spinner-border mb-3" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mb-0">Generating verification link...</p>
      </div>
    </div>
  </div>

  <div class="container position-sticky z-index-sticky top-0">
    <div class="row">
      <div class="col-12">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg blur border-radius-xl top-0 z-index-3 shadow position-absolute my-3 py-2 start-0 end-0 mx-4">
          <div class="container-fluid ps-2 pe-0">
            <a class="navbar-brand font-weight-bolder ms-lg-0 ms-3" href="#">
              <img src="../assets/img/uqudo-logo.svg" alt="Uqudo Logo" style="height: 32px;">
            </a>
            <div class="ms-auto d-flex align-items-center">
              <span id="customer-badge" class="customer-badge d-none">
                <i class="fas fa-building me-1"></i>
                <span id="customer-name">Customer</span>
              </span>
            </div>
          </div>
        </nav>
      </div>
    </div>
  </div>

  <main class="main-content mt-0">
    <div class="page-header align-items-start min-vh-100" style="background-image: url('https://images.unsplash.com/photo-1557683316-973673baf926?ixlib=rb-4.0.3&auto=format&fit=crop&w=2029&q=80');">
      <span class="mask bg-gradient-info opacity-6"></span>
      <div class="container my-auto pt-6">
        <div class="row justify-content-center">
          <div class="col-lg-5 col-md-8 col-12">
            <div class="card z-index-0 fadeIn3 fadeInBottom">
              <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                <div class="bg-gradient-info shadow-info border-radius-lg py-3 pe-1">
                  <h4 class="text-white font-weight-bolder text-center mt-2 mb-0">
                    <i class="fas fa-id-card me-2"></i>Identity Verification
                  </h4>
                  <p class="text-white text-sm text-center mb-0">Secure KYC Process</p>
                </div>
              </div>

              <div class="card-body text-center">
                <!-- Error State -->
                <div id="error-state" class="d-none py-4">
                  <div class="mb-4">
                    <i class="fas fa-exclamation-circle text-danger" style="font-size: 4rem;"></i>
                  </div>
                  <h5 class="text-dark">Unable to Generate Verification Link</h5>
                  <p class="text-muted mb-4" id="error-message">An error occurred. Please try again.</p>
                  <button class="btn bg-gradient-info" onclick="location.reload()">
                    <i class="fas fa-redo me-2"></i>Try Again
                  </button>
                </div>

                <!-- Expired State -->
                <div id="expired-state" class="d-none py-4">
                  <div class="mb-4">
                    <i class="fas fa-clock text-warning" style="font-size: 4rem;"></i>
                  </div>
                  <h5 class="text-dark">Verification Link Expired</h5>
                  <p class="text-muted mb-4">This verification link has expired. Please request a new one.</p>
                  <button class="btn bg-gradient-info" onclick="generateNewQR()">
                    <i class="fas fa-qrcode me-2"></i>Generate New Link
                  </button>
                </div>

                <!-- QR Code State -->
                <div id="qr-state">
                  <!-- Countdown Timer -->
                  <div class="mb-3">
                    <span id="countdown-badge" class="countdown-badge">
                      <span class="status-indicator"></span>
                      <span>Expires in <span id="countdown">5:00</span></span>
                    </span>
                  </div>

                  <!-- QR Code -->
                  <div class="qr-code-wrapper mb-4">
                    <div id="qr-code">
                      <div class="loading-skeleton" style="width: 200px; height: 200px;"></div>
                    </div>
                  </div>

                  <!-- Session ID -->
                  <div class="mb-3">
                    <small class="text-muted">Session ID</small>
                    <div class="d-flex align-items-center justify-content-center gap-2">
                      <code id="session-id" class="text-dark">Loading...</code>
                      <button class="btn btn-link btn-sm p-0" onclick="copySessionId()" title="Copy Session ID">
                        <i class="fas fa-copy text-info"></i>
                      </button>
                    </div>
                  </div>

                  <!-- Deep Link URL -->
                  <div class="mb-4">
                    <label class="form-label text-sm text-muted mb-2">Verification Link</label>
                    <div class="deep-link-url mb-2" id="deep-link-url">Loading...</div>
                    <button id="copy-btn" class="btn btn-copy bg-gradient-info btn-sm" onclick="copyDeepLink()">
                      <i class="fas fa-copy me-2"></i>Copy Link
                    </button>
                  </div>

                  <!-- Instructions -->
                  <div class="verification-info text-start">
                    <h6 class="text-dark mb-3">
                      <i class="fas fa-info-circle text-info me-2"></i>How to Complete Verification
                    </h6>

                    <div class="info-item">
                      <div class="info-icon scan">
                        <i class="fas fa-qrcode"></i>
                      </div>
                      <div>
                        <strong class="text-dark">Scan QR Code</strong>
                        <p class="text-muted text-sm mb-0">Use your phone camera or the Uqudo app</p>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon verify">
                        <i class="fas fa-id-card"></i>
                      </div>
                      <div>
                        <strong class="text-dark">Verify Identity</strong>
                        <p class="text-muted text-sm mb-0">Scan your ID document and take a selfie</p>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon secure">
                        <i class="fas fa-shield-alt"></i>
                      </div>
                      <div>
                        <strong class="text-dark">Secure & Private</strong>
                        <p class="text-muted text-sm mb-0">Your data is encrypted and protected</p>
                      </div>
                    </div>
                  </div>

                  <!-- App Download Links -->
                  <div class="mt-4 pt-3 border-top">
                    <p class="text-muted text-sm mb-3">Don't have the app? Download now:</p>
                    <div class="app-store-badges d-flex justify-content-center gap-3">
                      <a href="https://apps.apple.com/app/uqudo" target="_blank" rel="noopener">
                        <img src="https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg" alt="Download on App Store">
                      </a>
                      <a href="https://play.google.com/store/apps/details?id=com.uqudo.app" target="_blank" rel="noopener">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" alt="Get it on Google Play">
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Security Note -->
            <div class="text-center mt-4">
              <p class="text-white text-sm opacity-8">
                <i class="fas fa-lock me-1"></i>
                Powered by Uqudo - Enterprise Identity Verification
              </p>
            </div>
          </div>
        </div>
      </div>

      <footer class="footer position-absolute bottom-2 py-2 w-100">
        <div class="container">
          <div class="row align-items-center justify-content-center">
            <div class="col-12 col-md-6 my-auto">
              <div class="copyright text-center text-sm text-white">
                Â© <script>document.write(new Date().getFullYear())</script> Uqudo - Secure Identity Verification
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </main>

  <!-- Core JS Files -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../assets/js/material-dashboard.min.js?v=3.2.0"></script>

  <script>
    // Configuration
    const API_BASE_URL = window.location.origin + '/api';
    const DEEP_LINK_SCHEME = 'uqudo://verify';
    const UNIVERSAL_LINK_BASE = 'https://uqudo.app/verify';

    // State
    let currentSession = null;
    let countdownInterval = null;
    let expiryTime = null;

    // Get URL parameters
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        customerId: params.get('customer_id') || params.get('customerId'),
        customerName: params.get('customer_name') || params.get('customerName'),
        journeyId: params.get('journey_id') || params.get('journeyId'),
        referenceId: params.get('reference_id') || params.get('referenceId'),
        expiryMinutes: parseInt(params.get('expiry') || '5')
      };
    }

    // Initialize page
    async function init() {
      const params = getUrlParams();

      // Show customer name if provided
      if (params.customerName) {
        document.getElementById('customer-name').textContent = params.customerName;
        document.getElementById('customer-badge').classList.remove('d-none');
      }

      try {
        // Generate QR token and session
        const response = await fetch(`${API_BASE_URL}/qr-verification/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            customer_id: params.customerId,
            customer_name: params.customerName,
            journey_id: params.journeyId,
            reference_id: params.referenceId,
            expiry_minutes: params.expiryMinutes
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to generate verification link');
        }

        currentSession = data.data;

        // Generate QR code with deep link
        const deepLink = currentSession.deep_link || `${DEEP_LINK_SCHEME}?token=${currentSession.token}`;
        generateQRCode(deepLink);

        // Update UI
        document.getElementById('session-id').textContent = currentSession.session_id;
        document.getElementById('deep-link-url').textContent = deepLink;

        // Start countdown
        expiryTime = new Date(currentSession.expires_at);
        startCountdown();

        // Hide loading
        document.getElementById('loading-overlay').classList.add('d-none');

      } catch (error) {
        console.error('Initialization error:', error);
        showError(error.message);
      }
    }

    // Generate QR Code using qrcodejs library
    function generateQRCode(data) {
      const qrContainer = document.getElementById('qr-code');
      qrContainer.innerHTML = '';

      // Check if QRCode library is loaded
      if (typeof QRCode === 'undefined') {
        console.error('QRCode library not loaded');
        // Fallback: show a link instead
        qrContainer.innerHTML = `
          <div class="text-center p-3">
            <p class="text-muted mb-2">QR code unavailable</p>
            <a href="${data}" class="btn btn-sm bg-gradient-info">Open Link</a>
          </div>
        `;
        return;
      }

      try {
        // qrcodejs library API
        new QRCode(qrContainer, {
          text: data,
          width: 200,
          height: 200,
          colorDark: '#1a237e',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
      } catch (error) {
        console.error('QR generation error:', error);
        qrContainer.innerHTML = `
          <div class="text-center p-3">
            <p class="text-danger mb-2">Failed to generate QR code</p>
            <a href="${data}" class="btn btn-sm bg-gradient-info">Open Link</a>
          </div>
        `;
      }
    }

    // Start countdown timer
    function startCountdown() {
      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    // Update countdown display
    function updateCountdown() {
      const now = new Date();
      const diff = expiryTime - now;

      if (diff <= 0) {
        clearInterval(countdownInterval);
        showExpired();
        return;
      }

      const minutes = Math.floor(diff / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);

      const countdownEl = document.getElementById('countdown');
      countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      // Change badge color when less than 1 minute
      if (diff < 60000) {
        document.getElementById('countdown-badge').classList.add('expired');
      }
    }

    // Show expired state
    function showExpired() {
      document.getElementById('qr-state').classList.add('d-none');
      document.getElementById('error-state').classList.add('d-none');
      document.getElementById('expired-state').classList.remove('d-none');
      document.getElementById('loading-overlay').classList.add('d-none');
    }

    // Show error state
    function showError(message) {
      document.getElementById('qr-state').classList.add('d-none');
      document.getElementById('expired-state').classList.add('d-none');
      document.getElementById('error-state').classList.remove('d-none');
      document.getElementById('error-message').textContent = message;
      document.getElementById('loading-overlay').classList.add('d-none');
    }

    // Generate new QR code
    async function generateNewQR() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }

      document.getElementById('qr-state').classList.remove('d-none');
      document.getElementById('expired-state').classList.add('d-none');
      document.getElementById('error-state').classList.add('d-none');
      document.getElementById('loading-overlay').classList.remove('d-none');
      document.getElementById('countdown-badge').classList.remove('expired');

      await init();
    }

    // Copy deep link to clipboard
    function copyDeepLink() {
      const deepLink = document.getElementById('deep-link-url').textContent;
      navigator.clipboard.writeText(deepLink).then(() => {
        const btn = document.getElementById('copy-btn');
        btn.classList.add('copied');
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';

        setTimeout(() => {
          btn.classList.remove('copied');
          btn.innerHTML = '<i class="fas fa-copy me-2"></i>Copy Link';
        }, 2000);
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('Failed to copy. Please select and copy manually.');
      });
    }

    // Copy session ID to clipboard
    function copySessionId() {
      const sessionId = document.getElementById('session-id').textContent;
      navigator.clipboard.writeText(sessionId).then(() => {
        // Brief visual feedback
        const el = document.getElementById('session-id');
        el.style.background = '#e8f5e9';
        setTimeout(() => {
          el.style.background = '';
        }, 500);
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', init);
  </script>

  <!-- Theme Manager -->
  <script src="../assets/js/theme-manager.js"></script>

  <!-- Vercel Analytics -->
  <script type="module">
    import { inject } from 'https://cdn.jsdelivr.net/npm/@vercel/analytics@1.6.1/+esm';
    inject();
  </script>
</body>

</html>

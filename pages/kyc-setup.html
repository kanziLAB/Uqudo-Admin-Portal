<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" type="image/avif" href="../assets/img/FavIcon.avif">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/FavIcon.avif">
  <title>KYC Setup - Uqudo Admin Portal</title>

  <!-- Authentication & URL Protection -->
  <script>
    // Block direct .html access - redirect to clean URLs
    (function() {
      if (window.location.pathname.endsWith('.html')) {
        const cleanPath = window.location.pathname.replace('.html', '');
        window.location.replace(cleanPath + window.location.search + window.location.hash);
        return; // Stop execution after redirect
      }

      // Check authentication before page loads
      const authToken = localStorage.getItem('uqudo_token') || localStorage.getItem('auth_token');
      if (!authToken) {
        window.location.replace('/pages/uqudo-sign-in');
      }
    })();
  </script>

  <!-- Fonts and icons -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">

  <!-- Material Dashboard CSS -->
  <link id="pagestyle" href="../assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />
  <link href="../assets/css/uqudo-blue-theme.css" rel="stylesheet" />
  <link href="../assets/css/dark-mode.css" rel="stylesheet" />

  <style>
    .config-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .config-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .setting-row {
      padding: 1rem;
      border-bottom: 1px solid #f0f2f5;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .setting-row:last-child {
      border-bottom: none;
    }
    .setting-info {
      flex: 1;
    }
    .setting-label {
      font-weight: 600;
      color: #344767;
      margin-bottom: 0.25rem;
    }
    .setting-description {
      font-size: 0.875rem;
      color: #67748e;
      margin-bottom: 0;
    }
    .setting-control {
      margin-left: 1rem;
    }
    .country-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .country-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f0f2f5;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .country-item:last-child {
      border-bottom: none;
    }
    .country-flag {
      font-size: 1.5rem;
      margin-right: 0.75rem;
    }
    .risk-level-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }
    .risk-low { background: #4caf50; }
    .risk-medium { background: #ff9800; }
    .risk-high { background: #f44336; }
    .threshold-slider {
      width: 200px;
      position: relative;
    }
    .threshold-value {
      min-width: 50px;
      text-align: center;
      font-weight: 600;
      color: #1e88e5;
    }
    /* Slider tooltip styles */
    .slider-wrapper {
      position: relative;
      display: inline-block;
    }
    .slider-tooltip {
      position: absolute;
      background: #344767;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      top: -32px;
      transform: translateX(-50%);
      z-index: 1000;
    }
    .slider-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #344767 transparent transparent transparent;
    }
    .slider-wrapper:hover .slider-tooltip,
    .slider-wrapper.dragging .slider-tooltip {
      opacity: 1;
    }
  </style>
</head>

<body class="g-sidenav-show bg-gray-200">

  <!-- Sidebar -->
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-radius-lg fixed-start ms-2 bg-white my-2" id="sidenav-main">
    <div class="sidenav-header" style="height: 112px;">
      <i class="fas fa-times p-3 cursor-pointer text-dark opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0 p-0 d-block w-100 h-100 d-flex align-items-center" href="uqudo-dashboard">
        <img src="../assets/img/uqudo-logo.svg" alt="Uqudo Logo" style="width: 100%; height: auto; display: block;">
      </a>
    </div>
    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-dark" href="uqudo-dashboard">
            <i class="material-symbols-rounded opacity-5">dashboard</i>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="accounts">
            <i class="material-symbols-rounded opacity-5">group</i>
            <span class="nav-link-text ms-1">Accounts</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="alerts">
            <i class="material-symbols-rounded opacity-5">notifications_active</i>
            <span class="nav-link-text ms-1">KYC Alerts</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="cases">
            <i class="material-symbols-rounded opacity-5">gavel</i>
            <span class="nav-link-text ms-1">AML Cases</span>
        </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="./uqudo-analytics">
            <i class="material-symbols-rounded opacity-10">analytics</i>
            <span class="nav-link-text ms-1">Uqudo Analytics</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder opacity-5">Configuration</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link active bg-gradient-info text-white" href="kyc-setup">
            <i class="material-symbols-rounded opacity-5">settings</i>
            <span class="nav-link-text ms-1">KYC Setup</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="blocklist">
            <i class="material-symbols-rounded opacity-5">block</i>
            <span class="nav-link-text ms-1">Blocklist</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder opacity-5">Administration</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="user-access">
            <i class="material-symbols-rounded opacity-5">admin_panel_settings</i>
            <span class="nav-link-text ms-1">User Access</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="security-settings">
            <i class="material-symbols-rounded opacity-5">security</i>
            <span class="nav-link-text ms-1">Security Settings</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">

    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Configuration</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">KYC Setup</li>
          </ol>
          <h6 class="font-weight-bold mb-0">KYC Configuration</h6>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
          </div>
          <ul class="navbar-nav justify-content-end align-items-center">
            <li class="nav-item d-flex align-items-center me-2">
              <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode" aria-label="Toggle dark mode">
                <span class="material-symbols-rounded icon-sun">light_mode</span>
                <span class="material-symbols-rounded icon-moon">dark_mode</span>
              </button>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white bg-gradient-info font-weight-bold px-3 border-radius-md" onclick="logout()">
                <i class="material-symbols-rounded me-sm-1">logout</i>
                <span class="d-sm-inline d-none">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
    <div class="container-fluid py-2">

      <!-- Configuration Overview Cards -->
      <div class="row mb-4">
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card config-card">
            <div class="card-body p-3">
              <div class="d-flex">
                <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                  <i class="material-symbols-rounded opacity-10 text-white">verified_user</i>
                </div>
                <div class="ms-3">
                  <p class="text-sm mb-0 text-capitalize">Verification Types</p>
                  <h5 class="mb-0" id="verification-types-count">2</h5>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card config-card">
            <div class="card-body p-3">
              <div class="d-flex">
                <div class="icon icon-shape bg-gradient-success shadow text-center border-radius-md">
                  <i class="material-symbols-rounded opacity-10 text-white">public</i>
                </div>
                <div class="ms-3">
                  <p class="text-sm mb-0 text-capitalize">Supported Countries</p>
                  <h5 class="mb-0" id="supported-countries-count">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h5>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card config-card">
            <div class="card-body p-3">
              <div class="d-flex">
                <div class="icon icon-shape bg-gradient-warning shadow text-center border-radius-md">
                  <i class="material-symbols-rounded opacity-10 text-white">rule</i>
                </div>
                <div class="ms-3">
                  <p class="text-sm mb-0 text-capitalize">Active Rules</p>
                  <h5 class="mb-0" id="active-rules-count">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h5>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6">
          <div class="card config-card">
            <div class="card-body p-3">
              <div class="d-flex">
                <div class="icon icon-shape bg-gradient-danger shadow text-center border-radius-md">
                  <i class="material-symbols-rounded opacity-10 text-white">block</i>
                </div>
                <div class="ms-3">
                  <p class="text-sm mb-0 text-capitalize">Blocklist Entries</p>
                  <h5 class="mb-0" id="blocklist-entries-count">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h5>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- General Settings -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">General KYC Settings</h6>
                <button class="btn btn-sm bg-gradient-info" onclick="saveGeneralSettings()">
                  <i class="material-symbols-rounded text-sm">save</i> Save Changes
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Enable KYC Verification</div>
                  <div class="setting-description">Require identity verification for all new accounts</div>
                </div>
                <div class="setting-control">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enable-kyc" checked>
                  </div>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Auto-Approve Low Risk</div>
                  <div class="setting-description">Automatically approve accounts with low risk scores</div>
                </div>
                <div class="setting-control">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="auto-approve-low-risk">
                  </div>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Require Biometric Verification</div>
                  <div class="setting-description">Mandate biometric data (face, fingerprint) for verification</div>
                </div>
                <div class="setting-control">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="require-biometric" checked>
                  </div>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Require Liveness Check</div>
                  <div class="setting-description">Verify user presence with liveness detection</div>
                </div>
                <div class="setting-control">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="require-liveness" checked>
                  </div>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Enable Device Attestation</div>
                  <div class="setting-description">Verify device integrity and trustworthiness</div>
                </div>
                <div class="setting-control">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enable-device-attestation" checked>
                  </div>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">PEP Screening</div>
                  <div class="setting-description">Screen accounts against Politically Exposed Persons lists</div>
                </div>
                <div class="setting-control">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enable-pep-screening" checked>
                  </div>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Sanctions Screening</div>
                  <div class="setting-description">Check accounts against international sanctions lists</div>
                </div>
                <div class="setting-control">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enable-sanctions-screening" checked>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Thresholds -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Risk Score Thresholds</h6>
                <button class="btn btn-sm bg-gradient-info" onclick="saveRiskThresholds()">
                  <i class="material-symbols-rounded text-sm">save</i> Save Thresholds
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">
                    <span class="risk-level-indicator risk-low"></span> Low Risk Threshold
                  </div>
                  <div class="setting-description">Accounts below this score are considered low risk</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="0" max="100" value="30" id="threshold-low" oninput="updateThresholdValue('low', this.value)">
                  <span class="threshold-value" id="threshold-low-value">30</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">
                    <span class="risk-level-indicator risk-medium"></span> Medium Risk Threshold
                  </div>
                  <div class="setting-description">Accounts between low and this score are medium risk</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="0" max="100" value="70" id="threshold-medium" oninput="updateThresholdValue('medium', this.value)">
                  <span class="threshold-value" id="threshold-medium-value">70</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">
                    <span class="risk-level-indicator risk-high"></span> High Risk Threshold
                  </div>
                  <div class="setting-description">Accounts above medium threshold are high risk</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <span class="text-sm text-muted">Auto-calculated from medium threshold</span>
                  <span class="threshold-value" id="threshold-high-value">71+</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Biometric Confidence Threshold</div>
                  <div class="setting-description">Minimum confidence score for biometric verification</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="50" max="100" value="85" id="threshold-biometric" oninput="updateThresholdValue('biometric', this.value)">
                  <span class="threshold-value" id="threshold-biometric-value">85%</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">AML Match Threshold</div>
                  <div class="setting-description">Minimum score to trigger AML case creation</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="0" max="100" value="50" id="threshold-aml" oninput="updateThresholdValue('aml', this.value)">
                  <span class="threshold-value" id="threshold-aml-value">50%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SDK Verification Thresholds -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">SDK Verification Score Thresholds</h6>
                <button class="btn btn-sm bg-gradient-info" onclick="saveSDKThresholds()">
                  <i class="material-symbols-rounded text-sm">save</i> Save Thresholds
                </button>
              </div>
              <p class="text-sm text-secondary mb-0 mt-2">Configure minimum scores for SDK verification checks</p>
            </div>
            <div class="card-body">
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Face Match Threshold</div>
                  <div class="setting-description">Minimum score for face matching between document and selfie</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="50" max="100" value="80" id="sdk-face-match" oninput="updateSDKThresholdValue('face-match', this.value)">
                  <span class="threshold-value" id="sdk-face-match-value">80%</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Liveness Check Threshold</div>
                  <div class="setting-description">Minimum score for liveness detection (anti-spoofing)</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="50" max="100" value="85" id="sdk-liveness" oninput="updateSDKThresholdValue('liveness', this.value)">
                  <span class="threshold-value" id="sdk-liveness-value">85%</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Document Quality Threshold</div>
                  <div class="setting-description">Minimum quality score for document images</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="50" max="100" value="75" id="sdk-doc-quality" oninput="updateSDKThresholdValue('doc-quality', this.value)">
                  <span class="threshold-value" id="sdk-doc-quality-value">75%</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Face Quality Threshold</div>
                  <div class="setting-description">Minimum quality score for face/selfie images</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="50" max="100" value="75" id="sdk-face-quality" oninput="updateSDKThresholdValue('face-quality', this.value)">
                  <span class="threshold-value" id="sdk-face-quality-value">75%</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">OCR Confidence Threshold</div>
                  <div class="setting-description">Minimum confidence for OCR text extraction</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="50" max="100" value="85" id="sdk-ocr" oninput="updateSDKThresholdValue('ocr', this.value)">
                  <span class="threshold-value" id="sdk-ocr-value">85%</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">NFC Chip Reading Threshold</div>
                  <div class="setting-description">Minimum confidence for NFC chip data reading</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="50" max="100" value="90" id="sdk-nfc" oninput="updateSDKThresholdValue('nfc', this.value)">
                  <span class="threshold-value" id="sdk-nfc-value">90%</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Passive Authentication Threshold</div>
                  <div class="setting-description">Minimum score for document authenticity verification</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="50" max="100" value="85" id="sdk-passive-auth" oninput="updateSDKThresholdValue('passive-auth', this.value)">
                  <span class="threshold-value" id="sdk-passive-auth-value">85%</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Background Check Risk Threshold</div>
                  <div class="setting-description">Minimum risk score to create AML case (0-100)</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="0" max="100" value="70" id="sdk-bgcheck-risk" oninput="updateSDKThresholdValue('bgcheck-risk', this.value)">
                  <span class="threshold-value" id="sdk-bgcheck-risk-value">70</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Analytics Configuration -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0">
                    <i class="material-symbols-rounded text-info me-1" style="vertical-align: middle;">analytics</i>
                    Uqudo Analytics Configuration
                  </h6>
                  <p class="text-sm text-secondary mb-0 mt-1">Configure benchmarks and thresholds for SDK analytics dashboard</p>
                </div>
                <button class="btn btn-sm bg-gradient-info" onclick="saveAnalyticsConfig()">
                  <i class="material-symbols-rounded text-sm">save</i> Save Configuration
                </button>
              </div>
            </div>
            <div class="card-body">
              <!-- UX Benchmarks Section -->
              <h6 class="text-uppercase text-xs font-weight-bolder text-secondary mt-3 mb-3">
                <i class="material-symbols-rounded text-sm me-1">timer</i> UX Duration Benchmarks (seconds)
              </h6>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Document Scan Benchmark</div>
                  <div class="setting-description">Expected time for document scanning step</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="5" max="120" value="30" id="analytics-scan-benchmark" oninput="updateAnalyticsValue('scan-benchmark', this.value, 's')">
                  <span class="threshold-value" id="analytics-scan-benchmark-value">30s</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">NFC Reading Benchmark</div>
                  <div class="setting-description">Expected time for NFC chip reading step</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="3" max="60" value="15" id="analytics-nfc-benchmark" oninput="updateAnalyticsValue('nfc-benchmark', this.value, 's')">
                  <span class="threshold-value" id="analytics-nfc-benchmark-value">15s</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Face Verification Benchmark</div>
                  <div class="setting-description">Expected time for face verification step</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="5" max="90" value="20" id="analytics-face-benchmark" oninput="updateAnalyticsValue('face-benchmark', this.value, 's')">
                  <span class="threshold-value" id="analytics-face-benchmark-value">20s</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Background Check Benchmark</div>
                  <div class="setting-description">Expected time for background check step</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="1" max="30" value="5" id="analytics-bgc-benchmark" oninput="updateAnalyticsValue('bgc-benchmark', this.value, 's')">
                  <span class="threshold-value" id="analytics-bgc-benchmark-value">5s</span>
                </div>
              </div>

              <!-- Risk Score Thresholds Section -->
              <h6 class="text-uppercase text-xs font-weight-bolder text-secondary mt-4 mb-3">
                <i class="material-symbols-rounded text-sm me-1">security</i> Analytics Risk Score Thresholds
              </h6>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">
                    <span class="risk-level-indicator risk-low"></span> Low Risk (APPROVE)
                  </div>
                  <div class="setting-description">Sessions with total risk score below this are auto-approved</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="0" max="200" value="50" id="analytics-risk-low" oninput="updateAnalyticsValue('risk-low', this.value, '')">
                  <span class="threshold-value" id="analytics-risk-low-value">0-50</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">
                    <span class="risk-level-indicator risk-medium"></span> Medium Risk (REVIEW)
                  </div>
                  <div class="setting-description">Sessions between low and this threshold require review</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="50" max="300" value="100" id="analytics-risk-medium" oninput="updateAnalyticsValue('risk-medium', this.value, '')">
                  <span class="threshold-value" id="analytics-risk-medium-value">50-100</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">
                    <span class="risk-level-indicator risk-high"></span> High Risk (REVIEW)
                  </div>
                  <div class="setting-description">Sessions between medium and this threshold require careful review</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="100" max="400" value="200" id="analytics-risk-high" oninput="updateAnalyticsValue('risk-high', this.value, '')">
                  <span class="threshold-value" id="analytics-risk-high-value">100-200</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">
                    <span class="badge bg-danger" style="width: 12px; height: 12px; padding: 0; border-radius: 50%; display: inline-block; margin-right: 0.5rem;"></span> Critical Risk (REJECT)
                  </div>
                  <div class="setting-description">Sessions above high threshold are flagged for rejection</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <span class="text-sm text-muted">Auto-calculated</span>
                  <span class="threshold-value" id="analytics-risk-critical-value">200+</span>
                </div>
              </div>

              <!-- Friction Score Thresholds Section -->
              <h6 class="text-uppercase text-xs font-weight-bolder text-secondary mt-4 mb-3">
                <i class="material-symbols-rounded text-sm me-1">speed</i> Friction Score Thresholds
              </h6>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Low Friction Threshold</div>
                  <div class="setting-description">Friction score below this indicates smooth user experience</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="10" max="50" value="30" id="analytics-friction-low" oninput="updateAnalyticsValue('friction-low', this.value, '')">
                  <span class="threshold-value" id="analytics-friction-low-value">0-30</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Medium Friction Threshold</div>
                  <div class="setting-description">Friction score between low and this indicates moderate issues</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="40" max="100" value="70" id="analytics-friction-medium" oninput="updateAnalyticsValue('friction-medium', this.value, '')">
                  <span class="threshold-value" id="analytics-friction-medium-value">30-70</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">High Friction</div>
                  <div class="setting-description">Friction score above medium indicates significant UX issues</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <span class="text-sm text-muted">Auto-calculated</span>
                  <span class="threshold-value" id="analytics-friction-high-value">70+</span>
                </div>
              </div>

              <!-- Device Risk Thresholds Section -->
              <h6 class="text-uppercase text-xs font-weight-bolder text-secondary mt-4 mb-3">
                <i class="material-symbols-rounded text-sm me-1">devices</i> Device Risk Indicators
              </h6>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Multiple Attempts Threshold</div>
                  <div class="setting-description">Flag device if total sessions exceed this number</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="1" max="10" value="2" id="analytics-device-attempts" oninput="updateAnalyticsValue('device-attempts', this.value, ' sessions')">
                  <span class="threshold-value" id="analytics-device-attempts-value">2 sessions</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Low Success Rate Threshold</div>
                  <div class="setting-description">Flag device if success rate falls below this percentage</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="10" max="80" value="50" id="analytics-device-success-rate" oninput="updateAnalyticsValue('device-success-rate', this.value, '%')">
                  <span class="threshold-value" id="analytics-device-success-rate-value">50%</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Rapid Retry Window (minutes)</div>
                  <div class="setting-description">Flag device if multiple sessions within this time window</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="5" max="120" value="60" id="analytics-device-rapid-window" oninput="updateAnalyticsValue('device-rapid-window', this.value, ' min')">
                  <span class="threshold-value" id="analytics-device-rapid-window-value">60 min</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Historical Fraud Flags Threshold</div>
                  <div class="setting-description">Add risk points per this many historical fraud flags</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="1" max="20" value="5" id="analytics-device-fraud-flags" oninput="updateAnalyticsValue('device-fraud-flags', this.value, ' flags')">
                  <span class="threshold-value" id="analytics-device-fraud-flags-value">5 flags</span>
                </div>
              </div>

              <!-- Portfolio Dashboard Settings -->
              <h6 class="text-uppercase text-xs font-weight-bolder text-secondary mt-4 mb-3">
                <i class="material-symbols-rounded text-sm me-1">dashboard</i> Portfolio Dashboard Defaults
              </h6>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Default Date Range</div>
                  <div class="setting-description">Default time period for analytics dashboard</div>
                </div>
                <div class="setting-control">
                  <select class="form-select form-select-sm" id="analytics-default-date-range" style="width: 150px;">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="all">All time</option>
                  </select>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Completion Rate Target</div>
                  <div class="setting-description">Target completion rate for KPI comparison</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="50" max="100" value="85" id="analytics-completion-target" oninput="updateAnalyticsValue('completion-target', this.value, '%')">
                  <span class="threshold-value" id="analytics-completion-target-value">85%</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Abandonment Rate Target</div>
                  <div class="setting-description">Target maximum abandonment rate</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="1" max="30" value="10" id="analytics-abandonment-target" oninput="updateAnalyticsValue('abandonment-target', this.value, '%')">
                  <span class="threshold-value" id="analytics-abandonment-target-value">10%</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Review Rate Target</div>
                  <div class="setting-description">Target maximum review rate for sessions</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="5" max="50" value="20" id="analytics-review-target" oninput="updateAnalyticsValue('review-target', this.value, '%')">
                  <span class="threshold-value" id="analytics-review-target-value">20%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- QR Verification Configuration -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0">
                    <i class="material-symbols-rounded text-info me-1" style="vertical-align: middle;">qr_code_2</i>
                    QR Verification Configuration
                  </h6>
                  <p class="text-sm text-secondary mb-0 mt-1">Configure B2B customers for QR-based identity verification flows</p>
                </div>
                <button class="btn btn-sm bg-gradient-info" onclick="openAddCustomerModal()">
                  <i class="material-symbols-rounded text-sm">add</i> Add Customer
                </button>
              </div>
            </div>
            <div class="card-body">
              <!-- QR Generator Link -->
              <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
                <i class="material-symbols-rounded me-2">info</i>
                <div class="flex-grow-1">
                  <strong>QR Generator:</strong>
                  <a href="qr-generator" target="_blank" class="alert-link ms-1">Open QR Generator Page</a>
                  <span class="text-sm d-block">Use URL parameters: <code>?customer_id=xxx&customer_name=xxx</code></span>
                </div>
                <button class="btn btn-sm btn-outline-info ms-2" onclick="copyQRGeneratorUrl()">
                  <i class="material-symbols-rounded text-sm">content_copy</i> Copy URL
                </button>
              </div>

              <!-- URL Configuration -->
              <h6 class="text-uppercase text-xs font-weight-bolder text-secondary mb-3">
                <i class="material-symbols-rounded text-sm me-1">link</i> URL Configuration
              </h6>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Verification Portal Base URL</div>
                  <div class="setting-description">Base URL for QR verification links (change if hosting changes)</div>
                </div>
                <div class="setting-control">
                  <input type="text" class="form-control form-control-sm" id="qr-base-url" placeholder="https://your-domain.com" style="width: 300px;">
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Deep Link Scheme</div>
                  <div class="setting-description">App deep link scheme for mobile app integration</div>
                </div>
                <div class="setting-control">
                  <input type="text" class="form-control form-control-sm" id="qr-deep-link-scheme" placeholder="uqudo://verify" style="width: 250px;">
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Universal Link Base</div>
                  <div class="setting-description">Universal link for iOS/Android app association</div>
                </div>
                <div class="setting-control">
                  <input type="text" class="form-control form-control-sm" id="qr-universal-link" placeholder="https://uqudo.app/verify" style="width: 300px;">
                </div>
              </div>

              <!-- Default Settings -->
              <h6 class="text-uppercase text-xs font-weight-bolder text-secondary mt-4 mb-3">
                <i class="material-symbols-rounded text-sm me-1">settings</i> Default Settings
              </h6>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Default Token Expiry</div>
                  <div class="setting-description">How long QR verification links remain valid</div>
                </div>
                <div class="setting-control d-flex align-items-center gap-3">
                  <input type="range" class="form-range threshold-slider" min="1" max="30" value="5" id="qr-token-expiry" oninput="updateQRValue('token-expiry', this.value, ' min')">
                  <span class="threshold-value" id="qr-token-expiry-value">5 min</span>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Default Journey ID</div>
                  <div class="setting-description">Uqudo journey configuration to use when not specified</div>
                </div>
                <div class="setting-control">
                  <input type="text" class="form-control form-control-sm" id="qr-default-journey" placeholder="e.g., journey_abc123" style="width: 200px;">
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Allow One-Time Use Only</div>
                  <div class="setting-description">Each QR code can only be scanned once</div>
                </div>
                <div class="setting-control">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="qr-one-time-use" checked>
                  </div>
                </div>
              </div>

              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Enable Session Tracking</div>
                  <div class="setting-description">Track QR sessions in analytics dashboard</div>
                </div>
                <div class="setting-control">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="qr-session-tracking" checked>
                  </div>
                </div>
              </div>

              <!-- B2B Customers List -->
              <h6 class="text-uppercase text-xs font-weight-bolder text-secondary mt-4 mb-3">
                <i class="material-symbols-rounded text-sm me-1">business</i> B2B Customers
              </h6>

              <div id="qr-customers-list">
                <div class="text-center py-4">
                  <div class="spinner-border spinner-border-sm text-info" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>

              <!-- Save Button -->
              <div class="text-end mt-4 pt-3 border-top">
                <button class="btn bg-gradient-info" onclick="saveQRConfig()">
                  <i class="material-symbols-rounded text-sm">save</i> Save QR Configuration
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Supported Countries -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Supported Countries</h6>
                <button class="btn btn-sm bg-gradient-info" onclick="openAddCountryModal()">
                  <i class="material-symbols-rounded text-sm">add</i> Add Country
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="country-list" id="countries-list">
                <div class="text-center py-4">
                  <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Add B2B Customer Modal -->
  <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCustomerModalLabel">
            <i class="material-symbols-rounded me-2 text-info">business</i>Add B2B Customer
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Customer ID <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="customer-id" placeholder="e.g., vfs-global">
                <small class="text-muted">Unique identifier used in QR links</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Customer Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="customer-name-input" placeholder="e.g., VFS Global">
                <small class="text-muted">Display name shown to end users</small>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Contact Email</label>
                <input type="email" class="form-control" id="customer-email" placeholder="e.g., admin@vfsglobal.com">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Journey ID</label>
                <input type="text" class="form-control" id="customer-journey-id" placeholder="Override default journey">
                <small class="text-muted">Leave empty to use default</small>
              </div>
            </div>
          </div>

          <hr class="horizontal dark my-3">
          <h6 class="text-sm mb-3"><i class="material-symbols-rounded text-sm me-1">webhook</i> Webhook Configuration</h6>

          <div class="mb-3">
            <label class="form-label">Primary Webhook URL <span class="text-danger">*</span></label>
            <input type="url" class="form-control" id="customer-webhook-url" placeholder="https://api.customer.com/webhooks/kyc">
            <small class="text-muted">Receives SDK verification results in real-time</small>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Webhook Secret</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="customer-webhook-secret" placeholder="For signature verification">
                  <button class="btn btn-outline-secondary" type="button" onclick="generateWebhookSecret()">
                    <i class="material-symbols-rounded text-sm">autorenew</i>
                  </button>
                </div>
                <small class="text-muted">Used to sign webhook payloads</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Webhook Events</label>
                <select class="form-select" id="customer-webhook-events" multiple>
                  <option value="session.started" selected>Session Started</option>
                  <option value="session.completed" selected>Session Completed</option>
                  <option value="session.failed" selected>Session Failed</option>
                  <option value="session.expired">Session Expired</option>
                  <option value="verification.approved">Verification Approved</option>
                  <option value="verification.rejected">Verification Rejected</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Secondary Webhook URL (Optional)</label>
            <input type="url" class="form-control" id="customer-webhook-secondary" placeholder="https://backup.customer.com/webhooks/kyc">
            <small class="text-muted">Backup webhook for redundancy</small>
          </div>

          <hr class="horizontal dark my-3">
          <h6 class="text-sm mb-3"><i class="material-symbols-rounded text-sm me-1">tune</i> Customer Settings</h6>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Token Expiry (minutes)</label>
                <input type="number" class="form-control" id="customer-token-expiry" value="5" min="1" max="60">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Daily Verification Limit</label>
                <input type="number" class="form-control" id="customer-daily-limit" placeholder="Unlimited if empty">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="customer-is-active" checked>
                <label class="form-check-label" for="customer-is-active">Active</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="customer-sandbox-mode">
                <label class="form-check-label" for="customer-sandbox-mode">Sandbox Mode (Testing)</label>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Allowed IP Addresses (Optional)</label>
            <input type="text" class="form-control" id="customer-allowed-ips" placeholder="e.g., 192.168.1.1, 10.0.0.0/24">
            <small class="text-muted">Comma-separated list of IPs that can generate QR codes. Leave empty for no restriction.</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" id="customer-notes" rows="2" placeholder="Internal notes about this customer"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn bg-gradient-info" onclick="saveCustomer()">
            <i class="material-symbols-rounded text-sm">save</i> Save Customer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Country Modal -->
  <div class="modal fade" id="addCountryModal" tabindex="-1" aria-labelledby="addCountryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCountryModalLabel">Add Supported Country</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Country Name</label>
            <input type="text" class="form-control" id="country-name" placeholder="e.g., United Arab Emirates">
          </div>

          <div class="mb-3">
            <label class="form-label">Country Code (ISO)</label>
            <input type="text" class="form-control" id="country-code" placeholder="e.g., AE" maxlength="2">
          </div>

          <div class="mb-3">
            <label class="form-label">Risk Level</label>
            <select class="form-select" id="country-risk-level">
              <option value="low">Low Risk</option>
              <option value="medium">Medium Risk</option>
              <option value="high">High Risk</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Document Types Supported</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="doc-type-passport" checked>
              <label class="form-check-label" for="doc-type-passport">Passport</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="doc-type-id-card" checked>
              <label class="form-check-label" for="doc-type-id-card">National ID Card</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="doc-type-drivers-license">
              <label class="form-check-label" for="doc-type-drivers-license">Driver's License</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="doc-type-residence-permit">
              <label class="form-check-label" for="doc-type-residence-permit">Residence Permit</label>
            </div>
          </div>

          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="country-is-active" checked>
            <label class="form-check-label" for="country-is-active">Active</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn bg-gradient-info" onclick="saveCountry()">Add Country</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/api-client.js"></script>
  <script src="../assets/js/utils.js"></script>

  <script>
    // api is already defined globally in api-client.js

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadConfigStats();
      loadGeneralSettings();
      loadRiskThresholds();
      loadCountries();
      loadQRConfig();
      loadQRCustomers();
      initSliderTooltips();
    });

    // Initialize slider tooltips for analytics configuration
    function initSliderTooltips() {
      const sliders = document.querySelectorAll('.threshold-slider');

      sliders.forEach(slider => {
        // Wrap slider with tooltip container
        const wrapper = document.createElement('div');
        wrapper.className = 'slider-wrapper';
        slider.parentNode.insertBefore(wrapper, slider);
        wrapper.appendChild(slider);

        // Create tooltip element
        const tooltip = document.createElement('div');
        tooltip.className = 'slider-tooltip';
        wrapper.appendChild(tooltip);

        // Get suffix from oninput attribute or use default
        const oninputAttr = slider.getAttribute('oninput') || '';
        let suffix = '';
        const suffixMatch = oninputAttr.match(/'([^']*)'[^']*$/);
        if (suffixMatch) {
          suffix = suffixMatch[1];
        }

        // Update tooltip position and value
        function updateTooltip() {
          const value = slider.value;
          const min = parseFloat(slider.min);
          const max = parseFloat(slider.max);
          const percent = ((value - min) / (max - min)) * 100;

          tooltip.textContent = value + suffix;
          tooltip.style.left = `calc(${percent}% + (${8 - percent * 0.15}px))`;
        }

        // Initial update
        updateTooltip();

        // Update on input
        slider.addEventListener('input', updateTooltip);

        // Track dragging state for tooltip visibility
        slider.addEventListener('mousedown', () => wrapper.classList.add('dragging'));
        slider.addEventListener('touchstart', () => wrapper.classList.add('dragging'));
        document.addEventListener('mouseup', () => wrapper.classList.remove('dragging'));
        document.addEventListener('touchend', () => wrapper.classList.remove('dragging'));
      });
    }

    // Load configuration statistics
    async function loadConfigStats() {
      try {
        // Load supported countries count
        const countriesResponse = await api.getCountries();
        if (countriesResponse.success) {
          document.getElementById('supported-countries-count').textContent = countriesResponse.data.length;
        }

        // Load active rules count (placeholder for now)
        document.getElementById('active-rules-count').textContent = '12';

        // Load blocklist entries count
        const blocklistResponse = await api.getBlocklist({ limit: 1 });
        if (blocklistResponse.success && blocklistResponse.data.total) {
          document.getElementById('blocklist-entries-count').textContent = formatNumber(blocklistResponse.data.total);
        } else {
          document.getElementById('blocklist-entries-count').textContent = '0';
        }
      } catch (error) {
        console.error('Failed to load config stats:', error);
      }
    }

    // Load general settings
    async function loadGeneralSettings() {
      try {
        const response = await api.getKYCSetup();
        if (response.success && response.data) {
          const settings = response.data;
          document.getElementById('enable-kyc').checked = settings.enable_kyc !== false;
          document.getElementById('auto-approve-low-risk').checked = settings.auto_approve_low_risk || false;
          document.getElementById('require-biometric').checked = settings.require_biometric !== false;
          document.getElementById('require-liveness').checked = settings.require_liveness !== false;
          document.getElementById('enable-device-attestation').checked = settings.enable_device_attestation !== false;
          document.getElementById('enable-pep-screening').checked = settings.enable_pep_screening !== false;
          document.getElementById('enable-sanctions-screening').checked = settings.enable_sanctions_screening !== false;
        }
      } catch (error) {
        console.error('Failed to load general settings:', error);
      }
    }

    // Save general settings
    async function saveGeneralSettings() {
      const settings = {
        enable_kyc: document.getElementById('enable-kyc').checked,
        auto_approve_low_risk: document.getElementById('auto-approve-low-risk').checked,
        require_biometric: document.getElementById('require-biometric').checked,
        require_liveness: document.getElementById('require-liveness').checked,
        enable_device_attestation: document.getElementById('enable-device-attestation').checked,
        enable_pep_screening: document.getElementById('enable-pep-screening').checked,
        enable_sanctions_screening: document.getElementById('enable-sanctions-screening').checked
      };

      try {
        const response = await api.updateKYCSetup(settings);
        if (response.success) {
          showSuccess('General settings saved successfully');
        } else {
          showError(response.error || 'Failed to save settings');
        }
      } catch (error) {
        console.error('Failed to save general settings:', error);
        showError('Failed to save general settings');
      }
    }

    // Load risk thresholds
    async function loadRiskThresholds() {
      try {
        const response = await api.getKYCSetup();
        if (response.success && response.data && response.data.risk_thresholds) {
          const thresholds = response.data.risk_thresholds;
          if (thresholds.low) {
            document.getElementById('threshold-low').value = thresholds.low;
            updateThresholdValue('low', thresholds.low);
          }
          if (thresholds.medium) {
            document.getElementById('threshold-medium').value = thresholds.medium;
            updateThresholdValue('medium', thresholds.medium);
          }
          if (thresholds.biometric_confidence) {
            document.getElementById('threshold-biometric').value = thresholds.biometric_confidence;
            updateThresholdValue('biometric', thresholds.biometric_confidence);
          }
          if (thresholds.aml_match) {
            document.getElementById('threshold-aml').value = thresholds.aml_match;
            updateThresholdValue('aml', thresholds.aml_match);
          }
        }
      } catch (error) {
        console.error('Failed to load risk thresholds:', error);
      }
    }

    // Update threshold value display
    function updateThresholdValue(type, value) {
      if (type === 'low' || type === 'medium') {
        document.getElementById(`threshold-${type}-value`).textContent = value;
        if (type === 'medium') {
          document.getElementById('threshold-high-value').textContent = `${parseInt(value) + 1}+`;
        }
      } else if (type === 'biometric' || type === 'aml') {
        document.getElementById(`threshold-${type}-value`).textContent = `${value}%`;
      }
    }

    // Save risk thresholds
    async function saveRiskThresholds() {
      const thresholds = {
        risk_thresholds: {
          low: parseInt(document.getElementById('threshold-low').value),
          medium: parseInt(document.getElementById('threshold-medium').value),
          biometric_confidence: parseInt(document.getElementById('threshold-biometric').value),
          aml_match: parseInt(document.getElementById('threshold-aml').value)
        }
      };

      try {
        const response = await api.updateKYCSetup(thresholds);
        if (response.success) {
          showSuccess('Risk thresholds saved successfully');
        } else {
          showError(response.error || 'Failed to save thresholds');
        }
      } catch (error) {
        console.error('Failed to save risk thresholds:', error);
        showError('Failed to save risk thresholds');
      }
    }

    // Update SDK threshold value display
    function updateSDKThresholdValue(type, value) {
      const valueElement = document.getElementById(`sdk-${type}-value`);
      if (type === 'bgcheck-risk') {
        valueElement.textContent = value;
      } else {
        valueElement.textContent = `${value}%`;
      }
    }

    // Save SDK thresholds
    async function saveSDKThresholds() {
      const thresholds = {
        sdk_verification_thresholds: {
          face_match: parseInt(document.getElementById('sdk-face-match').value),
          liveness: parseInt(document.getElementById('sdk-liveness').value),
          document_quality: parseInt(document.getElementById('sdk-doc-quality').value),
          face_quality: parseInt(document.getElementById('sdk-face-quality').value),
          ocr_confidence: parseInt(document.getElementById('sdk-ocr').value),
          nfc_reading: parseInt(document.getElementById('sdk-nfc').value),
          passive_authentication: parseInt(document.getElementById('sdk-passive-auth').value),
          background_check_risk: parseInt(document.getElementById('sdk-bgcheck-risk').value)
        }
      };

      try {
        const response = await api.updateKYCSetup(thresholds);
        if (response.success) {
          showSuccess('SDK verification thresholds saved successfully');
        } else {
          showError(response.error || 'Failed to save SDK thresholds');
        }
      } catch (error) {
        console.error('Failed to save SDK thresholds:', error);
        showError('Failed to save SDK thresholds');
      }
    }

    // Update Analytics configuration value display
    function updateAnalyticsValue(type, value, suffix) {
      const valueElement = document.getElementById(`analytics-${type}-value`);

      // Handle range displays with auto-calculated values
      if (type === 'risk-low') {
        valueElement.textContent = `0-${value}`;
        // Update medium range start
        const mediumValue = document.getElementById('analytics-risk-medium').value;
        document.getElementById('analytics-risk-medium-value').textContent = `${value}-${mediumValue}`;
      } else if (type === 'risk-medium') {
        const lowValue = document.getElementById('analytics-risk-low').value;
        valueElement.textContent = `${lowValue}-${value}`;
        // Update high range
        const highValue = document.getElementById('analytics-risk-high').value;
        document.getElementById('analytics-risk-high-value').textContent = `${value}-${highValue}`;
      } else if (type === 'risk-high') {
        const mediumValue = document.getElementById('analytics-risk-medium').value;
        valueElement.textContent = `${mediumValue}-${value}`;
        document.getElementById('analytics-risk-critical-value').textContent = `${value}+`;
      } else if (type === 'friction-low') {
        valueElement.textContent = `0-${value}`;
        const mediumValue = document.getElementById('analytics-friction-medium').value;
        document.getElementById('analytics-friction-medium-value').textContent = `${value}-${mediumValue}`;
      } else if (type === 'friction-medium') {
        const lowValue = document.getElementById('analytics-friction-low').value;
        valueElement.textContent = `${lowValue}-${value}`;
        document.getElementById('analytics-friction-high-value').textContent = `${value}+`;
      } else {
        valueElement.textContent = `${value}${suffix}`;
      }
    }

    // Save Analytics configuration
    async function saveAnalyticsConfig() {
      const config = {
        analytics_config: {
          ux_benchmarks: {
            document_scan: parseInt(document.getElementById('analytics-scan-benchmark').value),
            nfc_reading: parseInt(document.getElementById('analytics-nfc-benchmark').value),
            face_verification: parseInt(document.getElementById('analytics-face-benchmark').value),
            background_check: parseInt(document.getElementById('analytics-bgc-benchmark').value)
          },
          risk_thresholds: {
            low: parseInt(document.getElementById('analytics-risk-low').value),
            medium: parseInt(document.getElementById('analytics-risk-medium').value),
            high: parseInt(document.getElementById('analytics-risk-high').value)
          },
          friction_thresholds: {
            low: parseInt(document.getElementById('analytics-friction-low').value),
            medium: parseInt(document.getElementById('analytics-friction-medium').value)
          },
          device_risk: {
            multiple_attempts_threshold: parseInt(document.getElementById('analytics-device-attempts').value),
            low_success_rate_threshold: parseInt(document.getElementById('analytics-device-success-rate').value),
            rapid_retry_window_minutes: parseInt(document.getElementById('analytics-device-rapid-window').value),
            fraud_flags_threshold: parseInt(document.getElementById('analytics-device-fraud-flags').value)
          },
          portfolio_defaults: {
            default_date_range: document.getElementById('analytics-default-date-range').value,
            completion_rate_target: parseInt(document.getElementById('analytics-completion-target').value),
            abandonment_rate_target: parseInt(document.getElementById('analytics-abandonment-target').value),
            review_rate_target: parseInt(document.getElementById('analytics-review-target').value)
          }
        }
      };

      try {
        const response = await api.updateKYCSetup(config);
        if (response.success) {
          showSuccess('Analytics configuration saved successfully');
        } else {
          showError(response.error || 'Failed to save analytics configuration');
        }
      } catch (error) {
        console.error('Failed to save analytics configuration:', error);
        showError('Failed to save analytics configuration');
      }
    }

    // Load countries
    async function loadCountries() {
      const container = document.getElementById('countries-list');

      try {
        const response = await api.getCountries();

        if (response.success) {
          const countries = response.data;

          if (countries.length === 0) {
            container.innerHTML = `
              <div class="text-center py-4">
                <i class="material-symbols-rounded text-secondary" style="font-size: 48px;">public_off</i>
                <p class="text-secondary mb-0">No countries configured</p>
              </div>
            `;
            return;
          }

          container.innerHTML = countries.map(country => `
            <div class="country-item">
              <div class="d-flex align-items-center flex-grow-1">
                <span class="country-flag">${getFlagEmoji(country.country_code)}</span>
                <div>
                  <h6 class="mb-0 text-sm">${country.country_name}</h6>
                  <p class="text-xs text-secondary mb-0">
                    ${country.country_code} 
                    <span class="risk-level-indicator risk-${country.risk_level}"></span>
                    ${capitalize(country.risk_level)} Risk
                  </p>
                </div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span class="badge badge-sm ${country.is_active ? 'badge-success' : 'badge-secondary'}">
                  ${country.is_active ? 'Active' : 'Inactive'}
                </span>
                <button class="btn btn-link text-secondary mb-0 p-0" onclick="toggleCountryStatus('${country.id}', ${!country.is_active})">
                  <i class="material-symbols-rounded text-sm">${country.is_active ? 'toggle_on' : 'toggle_off'}</i>
                </button>
                <button class="btn btn-link text-danger mb-0 p-0" onclick="deleteCountry('${country.id}')">
                  <i class="material-symbols-rounded text-sm">delete</i>
                </button>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Failed to load countries:', error);
        container.innerHTML = `
          <div class="text-center py-4 text-danger">
            <i class="material-symbols-rounded">error</i>
            <p>Failed to load countries</p>
          </div>
        `;
      }
    }

    // Open add country modal
    function openAddCountryModal() {
      const modal = new bootstrap.Modal(document.getElementById('addCountryModal'));
      document.getElementById('country-name').value = '';
      document.getElementById('country-code').value = '';
      document.getElementById('country-risk-level').value = 'low';
      document.getElementById('doc-type-passport').checked = true;
      document.getElementById('doc-type-id-card').checked = true;
      document.getElementById('doc-type-drivers-license').checked = false;
      document.getElementById('doc-type-residence-permit').checked = false;
      document.getElementById('country-is-active').checked = true;
      modal.show();
    }

    // Save country
    async function saveCountry() {
      const countryName = document.getElementById('country-name').value.trim();
      const countryCode = document.getElementById('country-code').value.trim().toUpperCase();
      const riskLevel = document.getElementById('country-risk-level').value;
      const isActive = document.getElementById('country-is-active').checked;

      if (!countryName || !countryCode) {
        showError('Please provide country name and code');
        return;
      }

      if (countryCode.length !== 2) {
        showError('Country code must be 2 letters (ISO format)');
        return;
      }

      const documentTypes = [];
      if (document.getElementById('doc-type-passport').checked) documentTypes.push('passport');
      if (document.getElementById('doc-type-id-card').checked) documentTypes.push('national_id');
      if (document.getElementById('doc-type-drivers-license').checked) documentTypes.push('drivers_license');
      if (document.getElementById('doc-type-residence-permit').checked) documentTypes.push('residence_permit');

      const countryData = {
        country_name: countryName,
        country_code: countryCode,
        risk_level: riskLevel,
        document_types_supported: documentTypes,
        is_active: isActive
      };

      try {
        const response = await api.addCountry(countryData);

        if (response.success) {
          showSuccess('Country added successfully');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addCountryModal'));
          modal.hide();
          loadCountries();
          loadConfigStats();
        } else {
          showError(response.error || 'Failed to add country');
        }
      } catch (error) {
        console.error('Failed to add country:', error);
        showError('Failed to add country');
      }
    }

    // Toggle country status
    async function toggleCountryStatus(countryId, newStatus) {
      try {
        const response = await api.updateCountry(countryId, { is_active: newStatus });

        if (response.success) {
          showSuccess(`Country ${newStatus ? 'activated' : 'deactivated'} successfully`);
          loadCountries();
        } else {
          showError(response.error || 'Failed to update country status');
        }
      } catch (error) {
        console.error('Failed to toggle country status:', error);
        showError('Failed to update country status');
      }
    }

    // Delete country
    async function deleteCountry(countryId) {
      const confirmed = await confirmAction('Are you sure you want to remove this country?', 'Delete Country');

      if (confirmed) {
        try {
          const response = await api.deleteCountry(countryId);

          if (response.success) {
            showSuccess('Country removed successfully');
            loadCountries();
            loadConfigStats();
          } else {
            showError(response.error || 'Failed to delete country');
          }
        } catch (error) {
          console.error('Failed to delete country:', error);
          showError('Failed to delete country');
        }
      }
    }

    // Get flag emoji for country code
    function getFlagEmoji(countryCode) {
      if (!countryCode || countryCode.length !== 2) return '';
      const codePoints = countryCode
        .toUpperCase()
        .split('')
        .map(char => 127397 + char.charCodeAt());
      return String.fromCodePoint(...codePoints);
    }

    // =====================================================
    // QR VERIFICATION CONFIGURATION
    // =====================================================

    // In-memory storage for QR customers (will be replaced with API calls)
    let qrCustomers = [];

    // Load QR configuration
    async function loadQRConfig() {
      try {
        const response = await api.getKYCSetup();
        if (response.success && response.data && response.data.qr_config) {
          const config = response.data.qr_config;

          // URL Configuration
          if (config.base_url) {
            document.getElementById('qr-base-url').value = config.base_url;
          } else {
            // Set default based on current location
            document.getElementById('qr-base-url').value = window.location.origin;
          }
          if (config.deep_link_scheme) {
            document.getElementById('qr-deep-link-scheme').value = config.deep_link_scheme;
          } else {
            document.getElementById('qr-deep-link-scheme').value = 'uqudo://verify';
          }
          if (config.universal_link_base) {
            document.getElementById('qr-universal-link').value = config.universal_link_base;
          } else {
            document.getElementById('qr-universal-link').value = 'https://uqudo.app/verify';
          }

          // Default Settings
          if (config.token_expiry_minutes) {
            document.getElementById('qr-token-expiry').value = config.token_expiry_minutes;
            updateQRValue('token-expiry', config.token_expiry_minutes, ' min');
          }
          if (config.default_journey_id) {
            document.getElementById('qr-default-journey').value = config.default_journey_id;
          }
          document.getElementById('qr-one-time-use').checked = config.one_time_use !== false;
          document.getElementById('qr-session-tracking').checked = config.session_tracking !== false;
        } else {
          // Set defaults when no config exists
          document.getElementById('qr-base-url').value = window.location.origin;
          document.getElementById('qr-deep-link-scheme').value = 'uqudo://verify';
          document.getElementById('qr-universal-link').value = 'https://uqudo.app/verify';
        }
      } catch (error) {
        console.error('Failed to load QR config:', error);
        // Set defaults on error
        document.getElementById('qr-base-url').value = window.location.origin;
        document.getElementById('qr-deep-link-scheme').value = 'uqudo://verify';
        document.getElementById('qr-universal-link').value = 'https://uqudo.app/verify';
      }
    }

    // Load QR customers list
    async function loadQRCustomers() {
      const container = document.getElementById('qr-customers-list');

      try {
        // Try to load from API - fall back to localStorage for demo
        let customers = [];
        try {
          const response = await api.request('/config/qr-customers');
          if (response.success) {
            customers = response.data || [];
          }
        } catch (e) {
          // Fall back to localStorage
          customers = JSON.parse(localStorage.getItem('qr_customers') || '[]');
        }

        qrCustomers = customers;

        if (customers.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="material-symbols-rounded text-secondary" style="font-size: 48px;">business</i>
              <p class="text-secondary mb-2">No B2B customers configured</p>
              <button class="btn btn-sm bg-gradient-info" onclick="openAddCustomerModal()">
                <i class="material-symbols-rounded text-sm">add</i> Add First Customer
              </button>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="table-responsive">
            <table class="table table-hover align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Customer</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Webhook</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Status</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Sessions</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${customers.map(customer => `
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0 text-sm">${customer.name}</h6>
                          <p class="text-xs text-secondary mb-0">
                            <code>${customer.id}</code>
                          </p>
                        </div>
                      </div>
                    </td>
                    <td>
                      <p class="text-xs mb-0 text-truncate" style="max-width: 200px;" title="${customer.webhook_url || 'Not configured'}">
                        ${customer.webhook_url ? `<i class="material-symbols-rounded text-success text-xs">check_circle</i> ${new URL(customer.webhook_url).hostname}` : '<span class="text-warning"><i class="material-symbols-rounded text-xs">warning</i> Not configured</span>'}
                      </p>
                    </td>
                    <td class="text-center">
                      <span class="badge badge-sm ${customer.is_active ? 'bg-gradient-success' : 'bg-gradient-secondary'}">
                        ${customer.is_active ? 'Active' : 'Inactive'}
                      </span>
                      ${customer.sandbox_mode ? '<span class="badge badge-sm bg-gradient-warning ms-1">Sandbox</span>' : ''}
                    </td>
                    <td class="text-center">
                      <span class="text-xs font-weight-bold">${customer.session_count || 0}</span>
                    </td>
                    <td class="text-end">
                      <button class="btn btn-link text-info mb-0 px-2" onclick="copyCustomerQRUrl('${customer.id}', '${customer.name}')" title="Copy QR URL">
                        <i class="material-symbols-rounded text-sm">link</i>
                      </button>
                      <button class="btn btn-link text-secondary mb-0 px-2" onclick="editCustomer('${customer.id}')" title="Edit">
                        <i class="material-symbols-rounded text-sm">edit</i>
                      </button>
                      <button class="btn btn-link text-danger mb-0 px-2" onclick="deleteCustomer('${customer.id}')" title="Delete">
                        <i class="material-symbols-rounded text-sm">delete</i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load QR customers:', error);
        container.innerHTML = `
          <div class="text-center py-4 text-danger">
            <i class="material-symbols-rounded">error</i>
            <p>Failed to load customers</p>
          </div>
        `;
      }
    }

    // Update QR value display
    function updateQRValue(type, value, suffix) {
      document.getElementById(`qr-${type}-value`).textContent = `${value}${suffix}`;
    }

    // Copy QR Generator URL
    function copyQRGeneratorUrl() {
      const url = `${window.location.origin}/pages/qr-generator`;
      navigator.clipboard.writeText(url).then(() => {
        showSuccess('QR Generator URL copied to clipboard');
      }).catch(() => {
        showError('Failed to copy URL');
      });
    }

    // Copy customer-specific QR URL
    function copyCustomerQRUrl(customerId, customerName) {
      const url = `${window.location.origin}/pages/qr-generator?customer_id=${encodeURIComponent(customerId)}&customer_name=${encodeURIComponent(customerName)}`;
      navigator.clipboard.writeText(url).then(() => {
        showSuccess(`QR URL for ${customerName} copied to clipboard`);
      }).catch(() => {
        showError('Failed to copy URL');
      });
    }

    // Open add customer modal
    function openAddCustomerModal() {
      // Reset form
      document.getElementById('customer-id').value = '';
      document.getElementById('customer-name-input').value = '';
      document.getElementById('customer-email').value = '';
      document.getElementById('customer-journey-id').value = '';
      document.getElementById('customer-webhook-url').value = '';
      document.getElementById('customer-webhook-secret').value = '';
      document.getElementById('customer-webhook-secondary').value = '';
      document.getElementById('customer-token-expiry').value = '5';
      document.getElementById('customer-daily-limit').value = '';
      document.getElementById('customer-is-active').checked = true;
      document.getElementById('customer-sandbox-mode').checked = false;
      document.getElementById('customer-allowed-ips').value = '';
      document.getElementById('customer-notes').value = '';

      // Reset webhook events selection
      const eventsSelect = document.getElementById('customer-webhook-events');
      Array.from(eventsSelect.options).forEach(option => {
        option.selected = ['session.started', 'session.completed', 'session.failed'].includes(option.value);
      });

      const modal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
      modal.show();
    }

    // Generate webhook secret
    function generateWebhookSecret() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      const secret = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
      document.getElementById('customer-webhook-secret').value = secret;
      document.getElementById('customer-webhook-secret').type = 'text';
      setTimeout(() => {
        document.getElementById('customer-webhook-secret').type = 'password';
      }, 3000);
    }

    // Save customer
    async function saveCustomer() {
      const customerId = document.getElementById('customer-id').value.trim();
      const customerName = document.getElementById('customer-name-input').value.trim();
      const webhookUrl = document.getElementById('customer-webhook-url').value.trim();

      if (!customerId || !customerName) {
        showError('Customer ID and Name are required');
        return;
      }

      if (!webhookUrl) {
        showError('Primary Webhook URL is required');
        return;
      }

      // Validate webhook URL
      try {
        new URL(webhookUrl);
      } catch (e) {
        showError('Invalid webhook URL format');
        return;
      }

      const eventsSelect = document.getElementById('customer-webhook-events');
      const selectedEvents = Array.from(eventsSelect.selectedOptions).map(opt => opt.value);

      const customerData = {
        id: customerId.toLowerCase().replace(/[^a-z0-9-]/g, '-'),
        name: customerName,
        email: document.getElementById('customer-email').value.trim() || null,
        journey_id: document.getElementById('customer-journey-id').value.trim() || null,
        webhook_url: webhookUrl,
        webhook_secret: document.getElementById('customer-webhook-secret').value || null,
        webhook_secondary: document.getElementById('customer-webhook-secondary').value.trim() || null,
        webhook_events: selectedEvents,
        token_expiry_minutes: parseInt(document.getElementById('customer-token-expiry').value) || 5,
        daily_limit: document.getElementById('customer-daily-limit').value ? parseInt(document.getElementById('customer-daily-limit').value) : null,
        is_active: document.getElementById('customer-is-active').checked,
        sandbox_mode: document.getElementById('customer-sandbox-mode').checked,
        allowed_ips: document.getElementById('customer-allowed-ips').value.trim() || null,
        notes: document.getElementById('customer-notes').value.trim() || null,
        created_at: new Date().toISOString(),
        session_count: 0
      };

      try {
        // Try to save via API
        try {
          const response = await api.request('/config/qr-customers', {
            method: 'POST',
            body: JSON.stringify(customerData)
          });
          if (!response.success) {
            throw new Error(response.error);
          }
        } catch (e) {
          // Fall back to localStorage
          const customers = JSON.parse(localStorage.getItem('qr_customers') || '[]');
          const existingIndex = customers.findIndex(c => c.id === customerData.id);
          if (existingIndex >= 0) {
            customers[existingIndex] = customerData;
          } else {
            customers.push(customerData);
          }
          localStorage.setItem('qr_customers', JSON.stringify(customers));
        }

        showSuccess('Customer saved successfully');
        const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
        modal.hide();
        loadQRCustomers();
      } catch (error) {
        console.error('Failed to save customer:', error);
        showError('Failed to save customer');
      }
    }

    // Edit customer
    function editCustomer(customerId) {
      const customer = qrCustomers.find(c => c.id === customerId);
      if (!customer) {
        showError('Customer not found');
        return;
      }

      document.getElementById('customer-id').value = customer.id;
      document.getElementById('customer-name-input').value = customer.name;
      document.getElementById('customer-email').value = customer.email || '';
      document.getElementById('customer-journey-id').value = customer.journey_id || '';
      document.getElementById('customer-webhook-url').value = customer.webhook_url || '';
      document.getElementById('customer-webhook-secret').value = customer.webhook_secret || '';
      document.getElementById('customer-webhook-secondary').value = customer.webhook_secondary || '';
      document.getElementById('customer-token-expiry').value = customer.token_expiry_minutes || 5;
      document.getElementById('customer-daily-limit').value = customer.daily_limit || '';
      document.getElementById('customer-is-active').checked = customer.is_active !== false;
      document.getElementById('customer-sandbox-mode').checked = customer.sandbox_mode || false;
      document.getElementById('customer-allowed-ips').value = customer.allowed_ips || '';
      document.getElementById('customer-notes').value = customer.notes || '';

      // Set webhook events
      const eventsSelect = document.getElementById('customer-webhook-events');
      Array.from(eventsSelect.options).forEach(option => {
        option.selected = (customer.webhook_events || []).includes(option.value);
      });

      const modal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
      modal.show();
    }

    // Delete customer
    async function deleteCustomer(customerId) {
      const customer = qrCustomers.find(c => c.id === customerId);
      const confirmed = await confirmAction(`Are you sure you want to delete ${customer?.name || customerId}?`, 'Delete Customer');

      if (confirmed) {
        try {
          // Try to delete via API
          try {
            await api.request(`/config/qr-customers/${customerId}`, { method: 'DELETE' });
          } catch (e) {
            // Fall back to localStorage
            const customers = JSON.parse(localStorage.getItem('qr_customers') || '[]');
            const filtered = customers.filter(c => c.id !== customerId);
            localStorage.setItem('qr_customers', JSON.stringify(filtered));
          }

          showSuccess('Customer deleted successfully');
          loadQRCustomers();
        } catch (error) {
          console.error('Failed to delete customer:', error);
          showError('Failed to delete customer');
        }
      }
    }

    // Save QR configuration
    async function saveQRConfig() {
      const baseUrl = document.getElementById('qr-base-url').value.trim();
      const deepLinkScheme = document.getElementById('qr-deep-link-scheme').value.trim();
      const universalLink = document.getElementById('qr-universal-link').value.trim();

      // Validate base URL
      if (baseUrl && !baseUrl.startsWith('http://') && !baseUrl.startsWith('https://')) {
        showError('Base URL must start with http:// or https://');
        return;
      }

      const config = {
        qr_config: {
          // URL Configuration
          base_url: baseUrl || window.location.origin,
          deep_link_scheme: deepLinkScheme || 'uqudo://verify',
          universal_link_base: universalLink || 'https://uqudo.app/verify',
          // Default Settings
          token_expiry_minutes: parseInt(document.getElementById('qr-token-expiry').value),
          default_journey_id: document.getElementById('qr-default-journey').value.trim() || null,
          one_time_use: document.getElementById('qr-one-time-use').checked,
          session_tracking: document.getElementById('qr-session-tracking').checked
        }
      };

      try {
        const response = await api.updateKYCSetup(config);
        if (response.success) {
          showSuccess('QR configuration saved successfully');
        } else {
          showError(response.error || 'Failed to save QR configuration');
        }
      } catch (error) {
        console.error('Failed to save QR config:', error);
        showError('Failed to save QR configuration');
      }
    }

    function logout() {
      localStorage.removeItem('uqudo_token');
      localStorage.removeItem('uqudo_user');
      localStorage.removeItem('auth_token');
      window.location.href = 'uqudo-sign-in';
    }
  </script>

  <!-- Theme Manager -->
  <script src="../assets/js/theme-manager.js"></script>

  <!-- Vercel Analytics -->
  <script type="module">
    import { inject } from 'https://cdn.jsdelivr.net/npm/@vercel/analytics@1.6.1/+esm';
    inject();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<!-- Version: 2.2 - DELETE BUTTON FORCED VISIBLE - Build: 2026-01-18 02:45 -->
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" type="image/avif" href="../assets/img/FavIcon.avif">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/FavIcon.avif">
  <title>Accounts Management - Uqudo Admin Portal</title>

  <!-- Authentication & URL Protection -->
  <script>
    // Block direct .html access - redirect to clean URLs
    if (window.location.pathname.endsWith('.html')) {
      const cleanPath = window.location.pathname.replace('.html', '');
      window.location.replace(cleanPath + window.location.search + window.location.hash);
    }

    // Check authentication before page loads
    (function() {
      const authToken = localStorage.getItem('uqudo_token') || localStorage.getItem('auth_token');
      if (!authToken) {
        window.location.replace('/pages/uqudo-sign-in');
      }
    })();
  </script>

  <!-- Fonts and icons -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">

  <!-- Material Dashboard CSS -->
  <link id="pagestyle" href="../assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />
  <link href="../assets/css/uqudo-blue-theme.css" rel="stylesheet" />
  <link href="../assets/css/performance-journey.css" rel="stylesheet" />

  <style>
    .account-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      font-size: 16px;
    }
    .verification-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.875rem;
    }
    .verification-badge i {
      font-size: 18px;
    }
    .filter-section {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
    }
    .stats-mini {
      font-size: 0.75rem;
      color: #67748e;
      margin-top: 0.25rem;
    }
    .action-dropdown {
      min-width: 160px;
    }
    .modal-section {
      margin-bottom: 1.5rem;
    }
    .modal-section-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #344767;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f0f2f5;
    }
    .info-label {
      font-weight: 500;
      color: #67748e;
    }
    .info-value {
      font-weight: 600;
      color: #344767;
    }
    .biometric-item {
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .device-card {
      background: #ffffff;
      border: 1px solid #e9ecef;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    .timeline-item {
      position: relative;
      padding-left: 2rem;
      padding-bottom: 1rem;
    }
    .timeline-item:before {
      content: '';
      position: absolute;
      left: 0.5rem;
      top: 0.5rem;
      bottom: -1rem;
      width: 2px;
      background: #e9ecef;
    }
    .timeline-item:last-child:before {
      display: none;
    }
    .timeline-dot {
      position: absolute;
      left: 0;
      top: 0.25rem;
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 50%;
      background: white;
      border: 3px solid #1e88e5;
    }
    .editable-label {
      cursor: pointer;
      position: relative;
      display: inline-block;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background-color 0.2s;
    }
    .editable-label:hover {
      background-color: rgba(30, 136, 229, 0.1);
    }
    .editable-label:hover::after {
      content: 'âœŽ';
      position: absolute;
      right: -18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: #1e88e5;
    }
    .editable-label-input {
      border: 2px solid #1e88e5;
      padding: 2px 4px;
      font-size: inherit;
      font-weight: inherit;
      border-radius: 3px;
      outline: none;
    }
  </style>
</head>

<body class="g-sidenav-show bg-gray-200">

  <!-- Sidebar -->
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-radius-lg fixed-start ms-2 bg-white my-2" id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-dark opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand px-4 py-3 m-0" href="uqudo-dashboard">
        <img src="../assets/img/uqudo-logo.png" alt="Uqudo Logo" style="height: 28px;">
      </a>
    </div>
    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-dark" href="uqudo-dashboard">
            <i class="material-symbols-rounded opacity-5">dashboard</i>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active bg-gradient-info text-white" href="accounts">
            <i class="material-symbols-rounded opacity-5">group</i>
            <span class="nav-link-text ms-1">Accounts</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="alerts">
            <i class="material-symbols-rounded opacity-5">notifications_active</i>
            <span class="nav-link-text ms-1">KYC Alerts</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="cases">
            <i class="material-symbols-rounded opacity-5">gavel</i>
            <span class="nav-link-text ms-1">AML Cases</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder opacity-5">Configuration</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="kyc-setup">
            <i class="material-symbols-rounded opacity-5">settings</i>
            <span class="nav-link-text ms-1">KYC Setup</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="blocklist">
            <i class="material-symbols-rounded opacity-5">block</i>
            <span class="nav-link-text ms-1">Blocklist</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">

    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Accounts</li>
          </ol>
          <h6 class="font-weight-bold mb-0">Accounts Management</h6>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
          </div>
          <ul class="navbar-nav justify-content-end">
            <li class="nav-item d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white bg-gradient-info font-weight-bold px-3 border-radius-md" onclick="logout()">
                <i class="material-symbols-rounded me-sm-1">logout</i>
                <span class="d-sm-inline d-none">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
    <div class="container-fluid py-2">

      <!-- Account Statistics -->
      <div class="row mb-4">
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-header p-2 ps-3">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-sm mb-0 editable-label" onclick="makeEditable(this)" data-original="Total Accounts">Total Accounts</p>
                  <h4 class="mb-0" id="total-accounts">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h4>
                  <p class="stats-mini mb-0 editable-label" onclick="makeEditable(this)" data-original="All registered users">All registered users</p>
                </div>
                <div class="icon icon-md icon-shape bg-gradient-info shadow-info text-center border-radius-lg">
                  <i class="material-symbols-rounded opacity-10 text-white">group</i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-header p-2 ps-3">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-sm mb-0 editable-label" onclick="makeEditable(this)" data-original="Active Accounts">Active Accounts</p>
                  <h4 class="mb-0 text-success" id="active-accounts">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h4>
                  <p class="stats-mini mb-0 editable-label" onclick="makeEditable(this)" data-original="Verified users">Verified users</p>
                </div>
                <div class="icon icon-md icon-shape bg-gradient-info shadow-info text-center border-radius-lg">
                  <i class="material-symbols-rounded opacity-10 text-white">verified</i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-header p-2 ps-3">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-sm mb-0 editable-label" onclick="makeEditable(this)" data-original="Pending Verification">Pending Verification</p>
                  <h4 class="mb-0 text-warning" id="pending-accounts">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h4>
                  <p class="stats-mini mb-0 editable-label" onclick="makeEditable(this)" data-original="Awaiting review">Awaiting review</p>
                </div>
                <div class="icon icon-md icon-shape bg-gradient-info shadow-info text-center border-radius-lg">
                  <i class="material-symbols-rounded opacity-10 text-white">pending</i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6">
          <div class="card">
            <div class="card-header p-2 ps-3">
              <div class="d-flex justify-content-between">
                <div>
                  <p class="text-sm mb-0 editable-label" onclick="makeEditable(this)" data-original="Rejected Accounts">Rejected Accounts</p>
                  <h4 class="mb-0 text-danger" id="rejected-accounts">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h4>
                  <p class="stats-mini mb-0 editable-label" onclick="makeEditable(this)" data-original="Failed verification">Failed verification</p>
                </div>
                <div class="icon icon-md icon-shape bg-gradient-info shadow-info text-center border-radius-lg">
                  <i class="material-symbols-rounded opacity-10 text-white">cancel</i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="filter-section">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label text-xs mb-1">Search</label>
                    <input type="text" class="form-control form-control-sm" id="search-input" placeholder="Name, email, or phone">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label text-xs mb-1">Status</label>
                    <select class="form-select form-select-sm" id="filter-status">
                      <option value="">All Statuses</option>
                      <option value="active">Active</option>
                      <option value="pending">Pending</option>
                      <option value="suspended">Suspended</option>
                      <option value="rejected">Rejected</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label text-xs mb-1">Verification Type</label>
                    <select class="form-select form-select-sm" id="filter-verification-type">
                      <option value="">All Types</option>
                      <option value="uae_national">UAE National</option>
                      <option value="international">International</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label text-xs mb-1">Risk Score</label>
                    <select class="form-select form-select-sm" id="filter-risk">
                      <option value="">All Levels</option>
                      <option value="low">Low</option>
                      <option value="medium">Medium</option>
                      <option value="high">High</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label text-xs mb-1">&nbsp;</label>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm bg-gradient-info text-white w-100" onclick="applyFilters()">
                        <i class="material-symbols-rounded text-sm">filter_alt</i> Apply Filters
                      </button>
                      <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">
                        <i class="material-symbols-rounded text-sm">clear</i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Accounts Table -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0">Customer Accounts</h6>
                </div>
                <div>
                  <button class="btn btn-info btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#createAccountModal">
                    <i class="material-symbols-rounded me-1">add</i> Add Account
                  </button>
                  <span class="text-sm text-secondary ms-3" id="accounts-count">Loading...</span>
                </div>
              </div>
            </div>
            <div class="card-body px-0 pb-2">
              <div class="table-responsive p-0">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Account</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Contact</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Verification</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">AML Status</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Risk Score</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Created</th>
                      <th class="text-secondary opacity-7"></th>
                    </tr>
                  </thead>
                  <tbody id="accounts-table-body">
                    <tr>
                      <td colspan="8" class="text-center py-4">
                        <div class="spinner-border text-info" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="px-3 py-3" id="pagination-container"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Account Detail Modal -->
  <div class="modal fade" id="accountDetailModal" tabindex="-1" aria-labelledby="accountDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="accountDetailModalLabel">Account Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Face Image Section -->
          <div class="row mb-4" id="face-image-section" style="display: none;">
            <div class="col-12 text-center">
              <div style="display: inline-block; position: relative;">
                <img id="detail-face-image" src="" alt="Face Image"
                     style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #1e88e5; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="position: absolute; bottom: 10px; right: 10px; background: #4caf50; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center;">
                  <i class="material-symbols-rounded" style="font-size: 14px; color: white;">check</i>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Left Column: Personal & Contact Info -->
            <div class="col-md-6">
              <div class="modal-section">
                <div class="modal-section-title">Personal Information</div>
                <div class="info-row">
                  <span class="info-label">Full Name</span>
                  <span class="info-value" id="detail-name">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Date of Birth</span>
                  <span class="info-value" id="detail-dob">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Nationality</span>
                  <span class="info-value" id="detail-nationality">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Document Type</span>
                  <span class="info-value" id="detail-document-type">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Document Number</span>
                  <span class="info-value" id="detail-document-number">-</span>
                </div>
              </div>

              <div class="modal-section">
                <div class="modal-section-title">Contact Information</div>
                <div class="info-row">
                  <span class="info-label">Email</span>
                  <span class="info-value" id="detail-email">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Phone</span>
                  <span class="info-value" id="detail-phone">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Address</span>
                  <span class="info-value" id="detail-address">-</span>
                </div>
              </div>

              <div class="modal-section">
                <div class="modal-section-title">Account Status</div>
                <div class="info-row">
                  <span class="info-label">Status</span>
                  <span class="info-value" id="detail-status">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Risk Score</span>
                  <span class="info-value" id="detail-risk-score">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Verification Type</span>
                  <span class="info-value" id="detail-verification-type">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Created At</span>
                  <span class="info-value" id="detail-created-at">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Last Updated</span>
                  <span class="info-value" id="detail-updated-at">-</span>
                </div>
              </div>
            </div>

            <!-- Right Column: Biometric & Device Info -->
            <div class="col-md-6">
              <div class="modal-section">
                <div class="modal-section-title">Document Images</div>
                <div id="document-images-container">
                  <p class="text-sm text-muted">Loading document images...</p>
                </div>
              </div>

              <div class="modal-section">
                <div class="modal-section-title">Verification Details</div>
                <div id="verification-details-container">
                  <p class="text-sm text-muted">Loading verification details...</p>
                </div>
              </div>

              <div class="modal-section">
                <div class="modal-section-title">Recent Activity</div>
                <div id="activity-timeline-container">
                  <p class="text-sm text-muted">Loading activity...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Performance Journey Section (Full Width) -->
          <div class="row mt-4">
            <div class="col-12">
              <div id="account-performance-journey"></div>
            </div>
          </div>

          <!-- SDK Submission Data Section (Full Width) -->
          <div class="row mt-4" id="sdk-submission-section" style="display: none;">
            <div class="col-12">
              <div class="modal-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <div class="modal-section-title mb-0">SDK Submission Data</div>
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleSDKDataExpanded()">
                    <i class="material-symbols-rounded text-sm">code</i> View Raw JSON
                  </button>
                </div>

                <!-- Collapsed View (Summary) -->
                <div id="sdk-data-summary">
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem;">
                        <div style="font-size: 0.75rem; color: #67748e; text-transform: uppercase; margin-bottom: 0.5rem;">SDK Info</div>
                        <div id="sdk-source-summary" style="font-size: 0.875rem;"></div>
                      </div>
                    </div>
                    <div class="col-md-4 mb-3">
                      <div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem;">
                        <div style="font-size: 0.75rem; color: #67748e; text-transform: uppercase; margin-bottom: 0.5rem;">Documents</div>
                        <div id="sdk-documents-summary" style="font-size: 0.875rem;"></div>
                      </div>
                    </div>
                    <div class="col-md-4 mb-3">
                      <div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem;">
                        <div style="font-size: 0.75rem; color: #67748e; text-transform: uppercase; margin-bottom: 0.5rem;">Verifications</div>
                        <div id="sdk-verifications-summary" style="font-size: 0.875rem;"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Expanded View (Full JSON) -->
                <div id="sdk-data-expanded" style="display: none;">
                  <div class="accordion" id="sdkDataAccordion">
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSource">
                          SDK Source
                        </button>
                      </h2>
                      <div id="collapseSource" class="accordion-collapse collapse show" data-bs-parent="#sdkDataAccordion">
                        <div class="accordion-body">
                          <pre id="sdk-source-json" style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; font-size: 0.75rem; max-height: 400px; overflow-y: auto;"></pre>
                        </div>
                      </div>
                    </div>
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDocuments">
                          SDK Documents
                        </button>
                      </h2>
                      <div id="collapseDocuments" class="accordion-collapse collapse" data-bs-parent="#sdkDataAccordion">
                        <div class="accordion-body">
                          <pre id="sdk-documents-json" style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; font-size: 0.75rem; max-height: 400px; overflow-y: auto;"></pre>
                        </div>
                      </div>
                    </div>
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVerifications">
                          SDK Verifications
                        </button>
                      </h2>
                      <div id="collapseVerifications" class="accordion-collapse collapse" data-bs-parent="#sdkDataAccordion">
                        <div class="accordion-body">
                          <pre id="sdk-verifications-json" style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; font-size: 0.75rem; max-height: 400px; overflow-y: auto;"></pre>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn bg-gradient-info" onclick="openActionModal()">Manual Action</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manual Action Modal -->
  <div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="actionModalLabel">Manual Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="action-account-id">

          <div class="mb-3">
            <label class="form-label">Action Type</label>
            <select class="form-select" id="action-type" required>
              <option value="">Select action...</option>
              <option value="APPROVE">Approve Account</option>
              <option value="SUSPEND">Suspend Account</option>
              <option value="REJECT">Reject Account</option>
              <option value="REACTIVATE">Reactivate Account</option>
              <option value="REQUEST_INFO">Request Additional Info</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Reason</label>
            <input type="text" class="form-control" id="action-reason" placeholder="Brief reason for action" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" id="action-notes" rows="3" placeholder="Detailed explanation..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn bg-gradient-info" id="submit-action">Submit Action</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Account Modal -->
  <div class="modal fade" id="createAccountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="create-account-form">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">User ID *</label>
                <input type="text" class="form-control" name="user_id" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" name="email" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">First Name *</label>
                <input type="text" class="form-control" name="first_name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Last Name *</label>
                <input type="text" class="form-control" name="last_name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Phone Number *</label>
                <input type="tel" class="form-control" name="phone_number" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Date of Birth *</label>
                <input type="date" class="form-control" name="date_of_birth" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">ID Type *</label>
                <select class="form-control" name="id_type" required>
                  <option value="">Select...</option>
                  <option value="passport">Passport</option>
                  <option value="eid">Emirates ID</option>
                  <option value="driving_license">Driving License</option>
                  <option value="visa">Visa</option>
                  <option value="pan_card">PAN Card</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">ID Number *</label>
                <input type="text" class="form-control" name="id_number" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Nationality</label>
                <input type="text" class="form-control" name="nationality">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Gender</label>
                <select class="form-control" name="gender">
                  <option value="">Select...</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-info" onclick="submitCreateAccount()">Create Account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Account Confirmation Modal -->
  <div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-gradient-danger">
          <h5 class="modal-title text-white">
            <i class="material-symbols-rounded me-2">warning</i>
            Delete Account
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="delete-account-id">
          <div class="alert alert-danger d-flex align-items-center" role="alert">
            <i class="material-symbols-rounded me-2">info</i>
            <div>
              <strong>Warning:</strong> This action cannot be undone. All related data will be permanently deleted.
            </div>
          </div>
          <p class="mb-3">Are you sure you want to delete the account for <strong id="delete-account-name"></strong>?</p>
          <p class="text-sm text-muted mb-3">The following data will be deleted:</p>
          <ul class="text-sm text-muted">
            <li>Account profile and personal information</li>
            <li>Biometric data and face images</li>
            <li>Device attestation records</li>
            <li>Activity logs and audit trail</li>
            <li>SDK submission data</li>
            <li>Related AML cases and alerts</li>
          </ul>
          <div class="form-group mt-3">
            <label class="form-label">Type <strong>DELETE</strong> to confirm:</label>
            <input type="text" class="form-control" id="delete-confirmation-input" placeholder="DELETE">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirm-delete-btn" onclick="deleteAccount()" disabled>
            <i class="material-symbols-rounded text-sm me-1">delete_forever</i>
            Delete Permanently
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/api-client.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/performance-journey.js"></script>

  <script>
    // Version check
    console.log('âœ… Accounts page loaded - Version 2.2 - DELETE BUTTON FORCED VISIBLE');

    // api is already defined globally in api-client.js
    let accounts = [];
    let currentPage = 1;
    let totalPages = 1;
    let currentFilters = {};
    let selectedAccountId = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadAccountStats();
      loadAccounts();

      // Submit action handler
      document.getElementById('submit-action').addEventListener('click', submitAction);

      // Search on Enter
      document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') applyFilters();
      });
    });

    // Load account statistics
    async function loadAccountStats() {
      try {
        // Fetch all accounts without pagination to get accurate counts
        const response = await api.getAccounts({ limit: 1000 });
        if (response.success) {
          const allAccounts = response.data.accounts || response.data;
          const total = response.data.total || allAccounts.length;

          // Calculate status counts
          const active = allAccounts.filter(a => a.account_status === 'active').length;
          const pending = allAccounts.filter(a => a.account_status === 'pending').length;
          const rejected = allAccounts.filter(a => a.account_status === 'rejected').length;

          document.getElementById('total-accounts').textContent = formatNumber(total);
          document.getElementById('active-accounts').textContent = formatNumber(active);
          document.getElementById('pending-accounts').textContent = formatNumber(pending);
          document.getElementById('rejected-accounts').textContent = formatNumber(rejected);
        }
      } catch (error) {
        console.error('Failed to load account stats:', error);
        // Set to 0 on error
        document.getElementById('total-accounts').textContent = '0';
        document.getElementById('active-accounts').textContent = '0';
        document.getElementById('pending-accounts').textContent = '0';
        document.getElementById('rejected-accounts').textContent = '0';
      }
    }

    // Load accounts with filters
    async function loadAccounts(page = 1) {
      currentPage = page;
      const tableBody = document.getElementById('accounts-table-body');
      tableBody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center py-4">
            <div class="spinner-border text-info" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </td>
        </tr>
      `;

      try {
        const params = {
          page: page,
          limit: 20,
          ...currentFilters
        };

        const response = await api.getAccounts(params);

        if (response.success) {
          accounts = response.data.accounts || response.data;
          totalPages = response.data.totalPages || 1;
          const total = response.data.total || accounts.length;

          document.getElementById('accounts-count').textContent =
            `Showing ${accounts.length} of ${formatNumber(total)} accounts`;

          if (accounts.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" class="text-center py-4">
                  <i class="material-symbols-rounded text-secondary" style="font-size: 48px;">inbox</i>
                  <p class="text-secondary mb-0">No accounts found</p>
                </td>
              </tr>
            `;
            return;
          }

          console.log('ðŸ”„ Rendering', accounts.length, 'accounts with View/Delete buttons');

          tableBody.innerHTML = accounts.map(account => {
            const initials = getInitials(account.first_name, account.last_name);
            const avatarColor = getAvatarColor(account.id);
            const hasFaceImage = account.face_image_url || account.face_image_base64;

            return `
              <tr>
                <td>
                  <div class="d-flex px-2 py-1">
                    ${hasFaceImage ? `
                      <div class="account-avatar" style="padding: 0; overflow: hidden;">
                        <img src="${account.face_image_base64 ? 'data:image/jpeg;base64,' + account.face_image_base64 : account.face_image_url}"
                             alt="Face"
                             style="width: 100%; height: 100%; object-fit: cover;"
                             onerror="this.parentElement.innerHTML='${initials}'; this.parentElement.style.background='${avatarColor}'; this.parentElement.style.padding='0'; this.parentElement.style.display='flex'; this.parentElement.style.alignItems='center'; this.parentElement.style.justifyContent='center'; this.parentElement.style.fontWeight='600'; this.parentElement.style.color='white'; this.parentElement.style.fontSize='16px';">
                      </div>
                    ` : `
                      <div class="account-avatar" style="background: ${avatarColor};">
                        ${initials}
                      </div>
                    `}
                    <div class="d-flex flex-column justify-content-center ms-2">
                      <h6 class="mb-0 text-sm">${account.first_name} ${account.last_name}</h6>
                      <p class="text-xs text-secondary mb-0">ID: ${account.id.substring(0, 8)}...</p>
                    </div>
                  </div>
                </td>
                <td>
                  <p class="text-xs mb-0">${account.email || '-'}</p>
                  <p class="text-xs text-secondary mb-0">${account.phone_number || '-'}</p>
                </td>
                <td>
                  <div class="verification-badge">
                    <i class="material-symbols-rounded text-${getSDKVerificationColor(account)}">
                      ${getSDKVerificationIcon(account)}
                    </i>
                    <span class="text-xs">${getSDKVersionLabel(account)}</span>
                  </div>
                </td>
                <td class="align-middle text-center text-sm">
                  <span class="badge badge-sm ${getAccountStatusBadge(getAccountStatusWithAML(account))}">
                    ${capitalize(getAccountStatusWithAML(account))}
                  </span>
                </td>
                <td class="align-middle text-center text-sm">
                  <span class="badge badge-sm ${getAMLStatusBadge(account.aml_status)}">
                    ${formatAMLStatus(account.aml_status || 'pending')}
                  </span>
                </td>
                <td class="align-middle text-center">
                  <span class="badge badge-sm ${getRiskScoreBadge(account.risk_score)}">
                    ${capitalize(account.risk_score || 'unknown')}
                  </span>
                </td>
                <td class="align-middle text-center">
                  <span class="text-secondary text-xs">${formatDate(account.created_at, { dateStyle: 'short' })}</span>
                </td>
                <td class="align-middle">
                  <button class="btn btn-link text-info text-gradient px-2 mb-0" onclick="viewAccountDetail('${account.id}')" title="View Details">
                    <i class="material-symbols-rounded text-sm me-1">visibility</i>
                    View
                  </button>
                  <button class="btn btn-link text-danger text-gradient px-2 mb-0" onclick="confirmDeleteAccount('${account.id}', '${account.first_name} ${account.last_name}')" title="Delete Account">
                    <i class="material-symbols-rounded text-sm me-1">delete</i>
                    Delete
                  </button>
                  <button class="btn btn-link text-warning text-gradient px-2 mb-0" onclick="openActionModalForAccount('${account.id}')" title="Manual Action">
                    <i class="material-symbols-rounded text-sm me-1">edit</i>
                    Action
                  </button>
                </td>
              </tr>
            `;
          }).join('');

          // Build pagination
          buildPagination('pagination-container', currentPage, totalPages, loadAccounts);
        }
      } catch (error) {
        console.error('Failed to load accounts:', error);
        showError('Failed to load accounts');
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-4 text-danger">
              <i class="material-symbols-rounded">error</i>
              <p>Failed to load accounts</p>
            </td>
          </tr>
        `;
      }
    }

    // Apply filters
    function applyFilters() {
      currentFilters = {};

      const search = document.getElementById('search-input').value.trim();
      const status = document.getElementById('filter-status').value;
      const verificationType = document.getElementById('filter-verification-type').value;
      const riskScore = document.getElementById('filter-risk').value;

      if (search) currentFilters.search = search;
      if (status) currentFilters.status = status;
      if (verificationType) currentFilters.verification_type = verificationType;
      if (riskScore) currentFilters.risk_score = riskScore;

      loadAccounts(1);
    }

    // Clear filters
    function clearFilters() {
      document.getElementById('search-input').value = '';
      document.getElementById('filter-status').value = '';
      document.getElementById('filter-verification-type').value = '';
      document.getElementById('filter-risk').value = '';
      currentFilters = {};
      loadAccounts(1);
    }

    // View account detail
    async function viewAccountDetail(accountId) {
      selectedAccountId = accountId;
      const modal = new bootstrap.Modal(document.getElementById('accountDetailModal'));

      try {
        const response = await api.getAccountById(accountId);

        if (response.success) {
          const account = response.data;

          // Display face image if available
          const faceImageSection = document.getElementById('face-image-section');
          const faceImage = document.getElementById('detail-face-image');

          if (account.face_image_url || account.face_image_base64) {
            faceImage.src = account.face_image_base64
              ? `data:image/jpeg;base64,${account.face_image_base64}`
              : account.face_image_url;
            faceImageSection.style.display = 'block';
          } else {
            faceImageSection.style.display = 'none';
          }

          // Personal Information
          document.getElementById('detail-name').textContent = `${account.first_name} ${account.last_name}`;
          document.getElementById('detail-dob').textContent = formatDate(account.date_of_birth, { dateStyle: 'medium' }) || '-';
          document.getElementById('detail-nationality').textContent = account.nationality || '-';
          document.getElementById('detail-document-type').textContent = snakeToTitle(account.document_type || '-');
          document.getElementById('detail-document-number').textContent = account.document_number || '-';

          // Contact Information
          document.getElementById('detail-email').textContent = account.email || '-';
          document.getElementById('detail-phone').textContent = account.phone_number || '-';
          document.getElementById('detail-address').textContent = account.address || '-';

          // Account Status
          document.getElementById('detail-status').innerHTML =
            `<span class="badge ${getAccountStatusBadge(account.status)}">${capitalize(account.status)}</span>`;
          document.getElementById('detail-risk-score').innerHTML =
            `<span class="badge ${getRiskScoreBadge(account.risk_score)}">${capitalize(account.risk_score || 'unknown')}</span>`;
          document.getElementById('detail-verification-type').textContent = snakeToTitle(account.verification_type || '-');
          document.getElementById('detail-created-at').textContent = formatDate(account.created_at, { dateStyle: 'medium', timeStyle: 'short' });
          document.getElementById('detail-updated-at').textContent = formatDate(account.updated_at, { dateStyle: 'medium', timeStyle: 'short' });

          // Load additional data
          loadDocumentImages(account);
          loadVerificationDetails(account);
          loadActivityLog(accountId);

          // Load Performance Journey
          loadPerformanceJourney(account);

          // Load SDK Submission Data
          loadSDKSubmissionData(account);

          modal.show();
        }
      } catch (error) {
        console.error('Failed to load account details:', error);
        showError('Failed to load account details');
      }
    }

    // Load document images
    function loadDocumentImages(account) {
      const container = document.getElementById('document-images-container');

      const hasDocumentFront = account.document_front_url;
      const hasDocumentBack = account.document_back_url;

      if (!hasDocumentFront && !hasDocumentBack) {
        container.innerHTML = '<p class="text-sm text-muted">No document images available</p>';
        return;
      }

      let imagesHtml = '<div class="row">';

      if (hasDocumentFront) {
        imagesHtml += `
          <div class="col-12 mb-3">
            <p class="text-xs font-weight-bold mb-2">Document Front</p>
            <img src="${account.document_front_url}" alt="Document Front"
                 style="width: 100%; max-width: 400px; border-radius: 0.5rem; border: 1px solid #e0e0e0;"
                 onerror="this.parentElement.innerHTML='<p class=\\'text-sm text-danger\\'>Failed to load front image</p>'">
          </div>
        `;
      }

      if (hasDocumentBack) {
        imagesHtml += `
          <div class="col-12 mb-3">
            <p class="text-xs font-weight-bold mb-2">Document Back</p>
            <img src="${account.document_back_url}" alt="Document Back"
                 style="width: 100%; max-width: 400px; border-radius: 0.5rem; border: 1px solid #e0e0e0;"
                 onerror="this.parentElement.innerHTML='<p class=\\'text-sm text-danger\\'>Failed to load back image</p>'">
          </div>
        `;
      }

      imagesHtml += '</div>';
      container.innerHTML = imagesHtml;
    }

    // Load verification details
    function loadVerificationDetails(account) {
      const container = document.getElementById('verification-details-container');

      const details = [];

      // SDK Information
      if (account.sdk_source) {
        details.push(`
          <div class="info-row">
            <span class="info-label">SDK Type</span>
            <span class="info-value">${account.sdk_source.sdkType || '-'}</span>
          </div>
        `);
        details.push(`
          <div class="info-row">
            <span class="info-label">SDK Version</span>
            <span class="info-value">${account.sdk_source.sdkVersion || '-'}</span>
          </div>
        `);
        details.push(`
          <div class="info-row">
            <span class="info-label">Device</span>
            <span class="info-value">${account.sdk_source.deviceModel || '-'}</span>
          </div>
        `);
        details.push(`
          <div class="info-row">
            <span class="info-label">Platform</span>
            <span class="info-value">${account.sdk_source.devicePlatform || '-'}</span>
          </div>
        `);
      }

      // Verification Status
      details.push(`
        <div class="info-row">
          <span class="info-label">Verification Channel</span>
          <span class="info-value">${snakeToTitle(account.verification_channel || 'unknown')}</span>
        </div>
      `);
      details.push(`
        <div class="info-row">
          <span class="info-label">Verification Type</span>
          <span class="info-value">${snakeToTitle(account.verification_type || 'unknown')}</span>
        </div>
      `);

      if (account.images_fetched_at) {
        details.push(`
          <div class="info-row">
            <span class="info-label">Images Fetched</span>
            <span class="info-value">${formatDate(account.images_fetched_at, { dateStyle: 'short', timeStyle: 'short' })}</span>
          </div>
        `);
      }

      container.innerHTML = details.length > 0 ? details.join('') : '<p class="text-sm text-muted">No verification details available</p>';
    }

    // Load activity log
    async function loadActivityLog(accountId) {
      const container = document.getElementById('activity-timeline-container');
      try {
        const response = await api.getAccountActivityLog(accountId, { limit: 10 });

        if (response.success && response.data.length > 0) {
          container.innerHTML = response.data.map(activity => `
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <div>
                <p class="text-sm mb-1"><strong>${snakeToTitle(activity.action)}</strong></p>
                <p class="text-xs text-muted mb-1">${activity.description || '-'}</p>
                <p class="text-xs text-muted mb-0">${formatDate(activity.created_at, { dateStyle: 'short', timeStyle: 'short' })}</p>
              </div>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<p class="text-sm text-muted">No recent activity</p>';
        }
      } catch (error) {
        container.innerHTML = '<p class="text-sm text-danger">Failed to load activity</p>';
      }
    }

    // Load Performance Journey
    function loadPerformanceJourney(account) {
      const events = parseSDKAnalytics(account);
      const journey = new PerformanceJourney('account-performance-journey', events);
      window.performanceJourney = journey; // Make globally accessible
      journey.render();
    }

    // Load SDK Submission Data
    function loadSDKSubmissionData(account) {
      const section = document.getElementById('sdk-submission-section');
      const hasSDKData = account.sdk_source || account.sdk_documents || account.sdk_verifications;

      if (!hasSDKData) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';

      // Populate summaries
      if (account.sdk_source) {
        document.getElementById('sdk-source-summary').innerHTML = `
          <div><strong>Type:</strong> ${account.sdk_source.sdkType || 'N/A'}</div>
          <div><strong>Version:</strong> ${account.sdk_source.sdkVersion || 'N/A'}</div>
          <div><strong>Platform:</strong> ${account.sdk_source.devicePlatform || 'N/A'}</div>
          <div><strong>Model:</strong> ${account.sdk_source.deviceModel || 'N/A'}</div>
        `;
      } else {
        document.getElementById('sdk-source-summary').innerHTML = '<em>No source data</em>';
      }

      if (account.sdk_documents && account.sdk_documents.length > 0) {
        const doc = account.sdk_documents[0];
        document.getElementById('sdk-documents-summary').innerHTML = `
          <div><strong>Type:</strong> ${doc.documentType || 'N/A'}</div>
          <div><strong>Has Reading:</strong> ${doc.reading ? 'Yes' : 'No'}</div>
          <div><strong>Has Scan:</strong> ${doc.scan ? 'Yes' : 'No'}</div>
          <div><strong>Total:</strong> ${account.sdk_documents.length} document(s)</div>
        `;
      } else {
        document.getElementById('sdk-documents-summary').innerHTML = '<em>No documents</em>';
      }

      if (account.sdk_verifications && account.sdk_verifications.length > 0) {
        const verif = account.sdk_verifications[0];
        const checks = [];
        if (verif.faceLiveness) checks.push('Face Liveness');
        if (verif.idScreenDetection) checks.push('Screen Detection');
        if (verif.faceMatch) checks.push('Face Match');

        document.getElementById('sdk-verifications-summary').innerHTML = `
          <div><strong>Checks:</strong> ${checks.length > 0 ? checks.join(', ') : 'None'}</div>
          <div><strong>Total:</strong> ${account.sdk_verifications.length} verification(s)</div>
        `;
      } else {
        document.getElementById('sdk-verifications-summary').innerHTML = '<em>No verifications</em>';
      }

      // Populate raw JSON
      document.getElementById('sdk-source-json').textContent = JSON.stringify(account.sdk_source || {}, null, 2);
      document.getElementById('sdk-documents-json').textContent = JSON.stringify(account.sdk_documents || [], null, 2);
      document.getElementById('sdk-verifications-json').textContent = JSON.stringify(account.sdk_verifications || [], null, 2);
    }

    // Toggle SDK data view
    function toggleSDKDataExpanded() {
      const summary = document.getElementById('sdk-data-summary');
      const expanded = document.getElementById('sdk-data-expanded');
      const isExpanded = expanded.style.display !== 'none';

      if (isExpanded) {
        expanded.style.display = 'none';
        summary.style.display = 'block';
      } else {
        expanded.style.display = 'block';
        summary.style.display = 'none';
      }
    }

    // Open action modal
    function openActionModal() {
      const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
      document.getElementById('action-account-id').value = selectedAccountId;
      document.getElementById('action-type').value = '';
      document.getElementById('action-reason').value = '';
      document.getElementById('action-notes').value = '';

      // Close detail modal
      const detailModal = bootstrap.Modal.getInstance(document.getElementById('accountDetailModal'));
      if (detailModal) detailModal.hide();

      actionModal.show();
    }

    // Open action modal for specific account
    function openActionModalForAccount(accountId) {
      selectedAccountId = accountId;
      const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
      document.getElementById('action-account-id').value = accountId;
      document.getElementById('action-type').value = '';
      document.getElementById('action-reason').value = '';
      document.getElementById('action-notes').value = '';
      actionModal.show();
    }

    // Submit action
    async function submitAction() {
      const accountId = document.getElementById('action-account-id').value;
      const action = document.getElementById('action-type').value;
      const reason = document.getElementById('action-reason').value;
      const notes = document.getElementById('action-notes').value;

      if (!action) {
        showError('Please select an action type');
        return;
      }

      if (!reason) {
        showError('Please provide a reason');
        return;
      }

      const submitBtn = document.getElementById('submit-action');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

      try {
        const response = await api.performAccountAction(accountId, action, reason, notes);

        if (response.success) {
          showSuccess(`Action ${action} completed successfully`);

          const modal = bootstrap.Modal.getInstance(document.getElementById('actionModal'));
          modal.hide();

          loadAccounts(currentPage);
          loadAccountStats();
        } else {
          showError(response.error || 'Failed to perform action');
        }
      } catch (error) {
        console.error('Failed to submit action:', error);
        showError('Failed to submit action');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Submit Action';
      }
    }

    // Placeholder functions for additional features
    function viewAccountDocuments(accountId) {
      showInfo('Document viewer feature coming soon');
    }

    function viewAccountActivity(accountId) {
      showInfo('Full activity log feature coming soon');
    }

    // Helper functions
    function getInitials(firstName, lastName) {
      const first = firstName ? firstName.charAt(0).toUpperCase() : '';
      const last = lastName ? lastName.charAt(0).toUpperCase() : '';
      return first + last || '??';
    }

    function getAvatarColor(id) {
      const colors = [
        '#1e88e5', '#43a047', '#fb8c00', '#e53935', '#8e24aa',
        '#3949ab', '#00acc1', '#7cb342', '#f4511e', '#6d4c41'
      ];
      const hash = id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
      return colors[hash % colors.length];
    }

    function getRiskScoreBadge(score) {
      const badges = {
        low: 'badge-success',
        medium: 'badge-warning',
        high: 'badge-danger'
      };
      return badges[score] || 'badge-secondary';
    }

    function getAMLStatusBadge(status) {
      const badges = {
        'aml_clear': 'badge-success',
        'pending': 'badge-warning',
        'aml_match_found': 'badge-danger',
        'under_review': 'badge-info'
      };
      return badges[status] || 'badge-secondary';
    }

    function formatAMLStatus(status) {
      const formats = {
        'aml_clear': 'AML Clear',
        'pending': 'Pending',
        'aml_match_found': 'AML Match Found',
        'under_review': 'Under Review'
      };
      return formats[status] || status;
    }

    async function submitCreateAccount() {
      const form = document.getElementById('create-account-form');
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      try {
        const response = await api.createAccount(data);
        if (response.success) {
          showSuccess('Account created successfully');
          bootstrap.Modal.getInstance(document.getElementById('createAccountModal')).hide();
          form.reset();
          loadAccounts();
        }
      } catch (error) {
        showError(error.message || 'Failed to create account');
      }
    }

    // Delete account functions
    function confirmDeleteAccount(accountId, accountName) {
      const modal = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
      document.getElementById('delete-account-id').value = accountId;
      document.getElementById('delete-account-name').textContent = accountName;
      document.getElementById('delete-confirmation-input').value = '';
      document.getElementById('confirm-delete-btn').disabled = true;
      modal.show();
    }

    // Enable delete button when user types DELETE
    document.addEventListener('DOMContentLoaded', function() {
      const deleteInput = document.getElementById('delete-confirmation-input');
      const deleteBtn = document.getElementById('confirm-delete-btn');

      if (deleteInput && deleteBtn) {
        deleteInput.addEventListener('input', function() {
          deleteBtn.disabled = this.value !== 'DELETE';
        });
      }
    });

    async function deleteAccount() {
      const accountId = document.getElementById('delete-account-id').value;
      const deleteBtn = document.getElementById('confirm-delete-btn');

      if (!accountId) {
        showError('Invalid account ID');
        return;
      }

      // Disable button and show loading state
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';

      try {
        const response = await api.deleteAccount(accountId);

        if (response.success) {
          showSuccess('Account and all related data deleted successfully');

          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('deleteAccountModal'));
          if (modal) modal.hide();

          // Reload accounts list
          loadAccounts(currentPage);
        } else {
          throw new Error(response.error || 'Failed to delete account');
        }
      } catch (error) {
        console.error('Failed to delete account:', error);
        showError(error.message || 'Failed to delete account');

        // Re-enable button
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '<i class="material-symbols-rounded text-sm me-1">delete_forever</i> Delete Permanently';
      }
    }

    // SDK Version helpers
    function getSDKVersionLabel(account) {
      if (!account.sdk_source) {
        return 'Manual';
      }

      const sdkType = account.sdk_source.sdkType?.toLowerCase() || '';
      const sdkVersion = account.sdk_source.sdkVersion || '';

      if (sdkType.includes('mobile') || sdkType.includes('android') || sdkType.includes('ios')) {
        return `Mobile ${sdkVersion ? 'v' + sdkVersion : ''}`.trim();
      } else if (sdkType.includes('web') || sdkType.includes('browser')) {
        return `Web ${sdkVersion ? 'v' + sdkVersion : ''}`.trim();
      }

      return sdkVersion ? `SDK v${sdkVersion}` : 'SDK';
    }

    function getSDKVerificationIcon(account) {
      if (!account.sdk_source) {
        return 'edit';
      }

      const sdkType = account.sdk_source.sdkType?.toLowerCase() || '';

      if (sdkType.includes('mobile') || sdkType.includes('android') || sdkType.includes('ios')) {
        return 'phone_iphone';
      } else if (sdkType.includes('web') || sdkType.includes('browser')) {
        return 'language';
      }

      return 'verified_user';
    }

    function getSDKVerificationColor(account) {
      if (!account.sdk_source) {
        return 'secondary';
      }

      const sdkType = account.sdk_source.sdkType?.toLowerCase() || '';

      if (sdkType.includes('mobile') || sdkType.includes('android') || sdkType.includes('ios')) {
        return 'success';
      } else if (sdkType.includes('web') || sdkType.includes('browser')) {
        return 'info';
      }

      return 'info';
    }

    // Update Account Status Badge to consider AML and scores
    function getAccountStatusBadge(status) {
      const badges = {
        active: 'badge-success',
        pending: 'badge-warning',
        suspended: 'badge-secondary',
        rejected: 'badge-danger',
        pending_review: 'badge-warning'
      };
      return badges[status] || 'badge-secondary';
    }

    // Enhanced status determination based on AML and scores
    function getAccountStatusWithAML(account) {
      // Check if account has AML match status
      if (account.aml_status === 'aml_match_found') {
        return 'under_review';
      }

      // Also check if there are actual AML hits/alerts in the account data
      if (account.aml_hits && account.aml_hits.length > 0) {
        return 'under_review';
      }

      // Check background_check_data for matches
      if (account.background_check_data && account.background_check_data.matches) {
        const matches = account.background_check_data.matches;
        if (Array.isArray(matches) && matches.length > 0) {
          return 'under_review';
        }
      }

      // If scores are very low (potential fraud)
      if (account.sdk_verifications && account.sdk_verifications.length > 0) {
        const verification = account.sdk_verifications[0];

        // Check face match score
        if (verification.faceMatch && verification.faceMatch.matchLevel < 2) {
          return 'rejected';
        }

        // Check liveness confidence
        if (verification.liveness && verification.liveness.confidence < 0.5) {
          return 'rejected';
        }
      }

      // Otherwise return actual status
      return account.account_status || account.status || 'pending';
    }

    function logout() {
      localStorage.removeItem('uqudo_token');
      localStorage.removeItem('uqudo_user');
      window.location.href = 'uqudo-sign-in.html';
    }

    // Editable Label Functionality
    function makeEditable(element) {
      // Prevent editing if already editing
      if (element.querySelector('input')) return;

      const currentText = element.textContent;
      const originalText = element.getAttribute('data-original');

      // Create input element
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentText;
      input.className = 'editable-label-input ' + element.className.replace('editable-label', '');

      // Replace content with input
      element.textContent = '';
      element.appendChild(input);
      input.focus();
      input.select();

      // Save on Enter or blur
      const saveEdit = () => {
        const newValue = input.value.trim();
        if (newValue) {
          element.textContent = newValue;
          // Save to localStorage for persistence
          const labelKey = 'widget_label_' + originalText.replace(/\s+/g, '_').toLowerCase();
          localStorage.setItem(labelKey, newValue);
          showSuccess('Label updated successfully');
        } else {
          element.textContent = currentText;
        }
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          saveEdit();
        } else if (e.key === 'Escape') {
          element.textContent = currentText;
        }
      });

      input.addEventListener('blur', saveEdit);
    }

    // Load saved labels on page load
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.editable-label').forEach(label => {
        const originalText = label.getAttribute('data-original');
        const labelKey = 'widget_label_' + originalText.replace(/\s+/g, '_').toLowerCase();
        const savedValue = localStorage.getItem(labelKey);
        if (savedValue) {
          label.textContent = savedValue;
        }
      });
    });
  </script>

  <!-- Vercel Analytics -->
  <script type="module">
    import { inject } from 'https://cdn.jsdelivr.net/npm/@vercel/analytics@1.6.1/+esm';
    inject();
  </script>
</body>
</html>
